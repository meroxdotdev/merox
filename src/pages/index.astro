---
import BlogCard from '@/components/BlogCard.astro'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import { buttonVariants } from '@/components/ui/button'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import { getRecentPosts } from '@/lib/data-utils'
import { SOCIAL_LINKS, ICON_MAP, SITE } from '@/consts'
import type { SocialLink } from '@/types'
import { Image } from 'astro:assets'
import heroImageLight from '../assets/meroxindatacenterwhite.webp'
import heroImageDark from '../assets/meroxindatacenterdark.webp'

// Data fetching with error handling
let latestPosts: Awaited<ReturnType<typeof getRecentPosts>> = []
let hasError = false

try {
  latestPosts = await getRecentPosts(SITE.featuredPostCount)
} catch (error) {
  console.error('Error fetching recent posts:', error)
  hasError = true
}

// Structured data schemas (use light variant as default for crawlers/schema)
const baseUrl = Astro.site?.href || SITE.href
const logoUrl = new URL(heroImageLight.src, baseUrl).href

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Robert Melcher",
  "alternateName": "merox",
  "url": baseUrl,
  "image": logoUrl,
  "jobTitle": "HPC System Administrator",
  "worksFor": { "@type": "Organization", "name": "Forvia" },
  "sameAs": [
    "https://github.com/meroxdotdev",
    "https://www.linkedin.com/in/robert-melcher-92a1a9157"
  ],
  "description": SITE.description
}

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": SITE.title,
  "url": baseUrl,
  "logo": logoUrl,
  "description": SITE.description,
  "founder": { "@type": "Person", "name": "Robert Melcher" }
}

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE.title,
  "url": baseUrl,
  "description": SITE.description,
  "author": { "@type": "Person", "name": "Robert Melcher" },
  "potentialAction": {
    "@type": "SearchAction",
    "target": { 
      "@type": "EntryPoint", 
      "urlTemplate": `${baseUrl}/blog?q={search_term_string}` 
    },
    "query-input": "required name=search_term_string"
  }
}

// Reusable class configurations
const primaryButtonClasses = 'rounded-full px-6 h-11 text-sm font-bold shadow-lg shadow-primary/20 transition-all hover:-translate-y-0.5 active:scale-95'
const outlineButtonClasses = 'rounded-full px-6 h-11 text-sm font-bold transition-all hover:-translate-y-0.5 active:scale-95'
---

<Layout class="max-w-4xl">
  <PageHead 
    slot="head" 
    title="Merox - Insights from my tech journey" 
    fullTitle={true} 
  >
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preload LCP hero images (theme-aware) for fast paint -->
    <link rel="preload" as="image" href={heroImageLight.src}>
    <link rel="preload" as="image" href={heroImageDark.src}>
  </PageHead>

  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  
  <style>
    @font-face {
      font-family: 'Love';
      src: url('/fonts/GABRWFFR.TTF') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* ── Dot-grid background ── */
    .hero-grid {
      background-size: 24px 24px;
      mask-image: radial-gradient(ellipse 70% 60% at 50% 40%, black 10%, transparent 100%);
      -webkit-mask-image: radial-gradient(ellipse 70% 60% at 50% 40%, black 10%, transparent 100%);
    }

    .hero-grid::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 50% 70% at 50% 100%, color-mix(in srgb, var(--primary) 4%, transparent) 0%, transparent 100%);
      pointer-events: none;
    }

    [data-theme='dark'] .hero-grid::before {
      background: radial-gradient(ellipse 50% 70% at 50% 100%, color-mix(in srgb, var(--primary) 6%, transparent) 0%, transparent 100%);
    }

    /* ── Bento grid layout ── */
    .bento-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .bento-grid {
        grid-template-columns: 5fr 3fr 4fr;
        grid-template-rows: auto auto auto auto;
        gap: 10px;
      }

      .bento-identity   { grid-column: 1 / 3; grid-row: 1; }  /* wide left  */
      .bento-photo      { grid-column: 3;     grid-row: 1; }
      .bento-quote      { grid-column: 1;     grid-row: 2; }
      .bento-connect    { grid-column: 2 / 4; grid-row: 2; }  /* wide right */
      .bento-linux      { grid-column: 1 / 3; grid-row: 3; }  /* wide left  */
      .bento-bike       { grid-column: 3;     grid-row: 3; }
      .bento-signature  { grid-column: 1 / -1; grid-row: 4; }  /* full width, sign-off */
    }

    .bento-signature {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1rem;
      min-height: auto;
    }

    .signature-text {
      font-family: 'Love', cursive;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      color: color-mix(in srgb, var(--foreground) 75%, var(--primary));
    }

    @media (min-width: 768px) {
      .signature-text { font-size: 1.15rem; }
    }

    /* ── Card base ── */
    .bento-card {
      border-radius: 1.125rem;
      border: 1px solid color-mix(in srgb, var(--border) 55%, transparent);
      background: color-mix(in srgb, var(--card) 60%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 1px 3px -1px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04);
      transition: border-color 0.35s ease, box-shadow 0.35s ease, transform 0.35s ease;
    }

    .bento-card:hover {
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      box-shadow: 0 4px 20px -6px color-mix(in srgb, var(--primary) 12%, transparent),
                  0 1px 3px -1px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    /* ── Social chip ── */
    .social-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.7rem;
      border-radius: 0.6rem;
      font-size: 0.75rem;
      font-weight: 500;
      background: color-mix(in srgb, var(--muted) 60%, transparent);
      border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
      color: color-mix(in srgb, var(--foreground) 88%, var(--muted-foreground));
      transition: all 0.25s ease;
    }

    .social-chip:hover {
      background: color-mix(in srgb, var(--primary) 12%, transparent);
      border-color: color-mix(in srgb, var(--primary) 25%, transparent);
      color: var(--foreground);
    }

    .social-chip:hover .social-chip-icon {
      color: var(--primary);
    }

    /* ── Staggered card entrance ── */
    @media (prefers-reduced-motion: no-preference) {
      .bento-card {
        animation: bentoFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
        animation-delay: calc(var(--delay, 0) * 1ms);
      }

      @keyframes bentoFadeIn {
        from {
          opacity: 0;
          transform: translateY(16px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Insight cards (blog section) */
      .insight-card {
        animation: insightFadeIn 0.5s ease-out both;
        animation-delay: calc(var(--delay, 0) * 1ms);
      }

      @keyframes insightFadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }
  </style>

  <section class="hero-section relative pt-6 pb-8 md:pt-10 md:pb-14">
    <!-- Dot-grid background -->
    <div 
      class="hero-grid absolute inset-0 -z-20 h-full w-[100vw] left-1/2 -translate-x-1/2 
             bg-[radial-gradient(circle,#00000018_1px,transparent_1px)] 
             dark:bg-[radial-gradient(circle,#ffffff18_1px,transparent_1px)]"
      aria-hidden="true"
    ></div>

    <!-- Bento grid -->
    <div class="bento-grid">

      <!-- Identity card -->
      <div class="bento-card bento-identity p-5 md:p-6 pb-4 md:pb-5" style="--delay: 0">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/8 border border-primary/10 text-xs font-mono mb-4">
          <span class="relative flex size-2">
            <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-additive/50"></span>
            <span class="relative inline-flex size-2 rounded-full bg-additive"></span>
          </span>
          <span class="text-foreground/70">HPC System Administrator</span>
          <span class="text-muted-foreground/30 mx-0.5">/</span>
          <span class="text-muted-foreground/60">Forvia</span>
        </div>
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tighter uppercase leading-[0.92]">
          Building<br />infrastructure<br /><span class="text-primary">that scales</span>.
        </h1>
        <p class="mt-3 text-sm md:text-[15px] text-muted-foreground/70 max-w-md leading-relaxed">
          System administrator exploring HPC, security &amp; everything in between.
          Writing about what works &mdash; and what spectacularly doesn't.
        </p>
        <div class="flex flex-wrap items-center gap-3 mt-5">
          <Link 
            href="/blog" 
            class={buttonVariants({ variant: 'default', size: 'lg', class: primaryButtonClasses })}
          >
            Read the blog
            <Icon name="lucide:arrow-right" class="ml-2 size-4" aria-hidden="true" />
          </Link>
          <Link 
            href="/about" 
            class={buttonVariants({ variant: 'outline', size: 'lg', class: outlineButtonClasses })}
          >
            About me
          </Link>
        </div>
      </div>

      <!-- Photo card: theme-aware datacenter image (light/dark), one visible by theme -->
      <div class="bento-card bento-photo overflow-hidden relative group h-72 md:h-auto" style="--delay: 80">
        <div class="relative w-full h-full">
          <Image
            src={heroImageLight}
            alt="Robert Melcher in datacenter"
            widths={[300, 500, heroImageLight.width]}
            sizes="(max-width: 768px) 100vw, 280px"
            loading="eager"
            fetchpriority="high"
            class="w-full h-full object-cover object-[center_15%] md:object-top transition-transform duration-700 ease-out group-hover:scale-[1.04] dark:opacity-0 dark:pointer-events-none"
          />
          <Image
            src={heroImageDark}
            alt="Robert Melcher in datacenter"
            widths={[300, 500, heroImageDark.width]}
            sizes="(max-width: 768px) 100vw, 280px"
            loading="eager"
            fetchpriority="high"
            class="absolute inset-0 w-full h-full object-cover object-[center_15%] md:object-top transition-transform duration-700 ease-out group-hover:scale-[1.04] opacity-0 pointer-events-none dark:opacity-100 dark:pointer-events-auto"
          />
        </div>
      </div>

      <!-- Signature card: near photo on mobile, bottom row on desktop -->
      <div class="bento-card bento-signature" style="--delay: 100" aria-label="Signature">
        <span class="signature-text select-none">./merox.sh --live</span>
      </div>

      <!-- Quote card -->
      <div class="bento-card bento-quote p-5 md:p-6 flex items-center" style="--delay: 160">
        <blockquote class="text-lg md:text-xl italic leading-snug text-foreground/90">
          <span class="text-primary/60 not-italic">&ldquo;</span>Works in theory &mdash;<br />now let&rsquo;s see what <span class="text-foreground font-semibold not-italic">doesn&rsquo;t</span><span class="text-primary/60 not-italic">&rdquo;</span>
        </blockquote>
      </div>

      <!-- Connect card -->
      <div class="bento-card bento-connect p-4" style="--delay: 240">
        <div class="flex items-center justify-between mb-3">
          <span class="text-[10px] font-mono uppercase tracking-widest text-foreground/80">Connect</span>
          <div class="flex items-center gap-1.5">
            <span class="relative flex size-1.5">
              <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-additive/50"></span>
              <span class="relative inline-flex size-1.5 rounded-full bg-additive"></span>
            </span>
            <span class="text-[10px] font-mono text-foreground/80">online</span>
          </div>
        </div>
        <nav aria-label="Social links">
          <ul class="flex flex-wrap gap-1.5" role="list">
            {SOCIAL_LINKS.map(({ href, label }: SocialLink) => (
              <li>
                <Link href={href} aria-label={label} title={label} class="social-chip">
                  <Icon 
                    name={ICON_MAP[label as keyof typeof ICON_MAP] || 'lucide:message-circle'} 
                    class="size-3.5 social-chip-icon text-foreground/80 transition-colors" 
                  />
                  <span>{label}</span>
                </Link>
              </li>
            ))}
          </ul>
        </nav>
        <a href="mailto:hello@merox.dev" class="inline-flex items-center gap-1.5 text-xs font-mono text-foreground/85 hover:text-primary transition-colors mt-3">
          <Icon name="lucide:mail" class="size-3" aria-hidden="true" />
          hello@merox.dev
        </a>
      </div>

      <!-- Linux card -->
      <div class="bento-card bento-linux p-4 md:p-5 flex items-center gap-4 group/linux" style="--delay: 300">
        <div class="flex-shrink-0 text-primary/20 group-hover/linux:text-primary/40 transition-colors duration-500">
          <Icon name="lucide:terminal" class="size-10 md:size-12" aria-hidden="true" />
        </div>
        <div>
          <span class="text-sm font-medium text-foreground">Powered by Linux</span>
          <span class="block text-xs text-muted-foreground/85 mt-0.5 font-mono">uptime: since forever</span>
        </div>
      </div>

      <!-- Bike card -->
      <div class="bento-card bento-bike p-4 md:p-5 flex items-center gap-4 group/bike" style="--delay: 360">
        <div class="flex-shrink-0 text-primary/20 group-hover/bike:text-primary/40 transition-colors duration-500">
          <Icon name="lucide:mountain-snow" class="size-10 md:size-12" aria-hidden="true" />
        </div>
        <div>
          <span class="text-sm font-medium text-foreground">Trail therapy</span>
          <span class="block text-xs text-muted-foreground/85 mt-0.5">Weekend reset protocol</span>
        </div>
      </div>
    </div>
  </section>

  {latestPosts && latestPosts.length > 0 && (
    <section class="mt-4 pt-6 md:mt-8 md:pt-10 relative">
      <div 
        class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-border/40 to-transparent"
        aria-hidden="true"
      >
      </div>
      
      <div class="mb-8 md:mb-10">
        <h2 class="text-2xl font-black tracking-tighter uppercase leading-none text-foreground">
          Latest <span class="text-primary">Insights</span>
        </h2>
        <p class="mt-2.5 text-sm md:text-base text-muted-foreground/70 max-w-lg">
          Recent writing on infrastructure, security & homelab experiments.
        </p>
      </div>
      
      <div class="flex flex-col gap-5">
        {latestPosts[0] && (
          <div class="insight-card" style="--delay: 0">
            <BlogCard entry={latestPosts[0]} variant="hero" index={0} />
          </div>
        )}
        
        {latestPosts.length > 1 && (
          <div class="grid grid-cols-1 md:grid-cols-2 md:auto-rows-fr gap-5">
            {latestPosts.slice(1).map((post, i) => (
              <div class="insight-card" style={`--delay: ${(i + 1) * 120}`}>
                <BlogCard entry={post} variant="featured" index={i + 1} />
              </div>
            ))}
          </div>
        )}
      </div>
      
      <div class="mt-10 md:mt-14 flex justify-center">
        <Link 
          href="/blog" 
          class={buttonVariants({ variant: 'outline', size: 'lg', class: 'group/cta rounded-full px-8 h-12 font-bold transition-all hover:-translate-y-0.5' })}
        >
          Explore all posts
          <Icon name="lucide:arrow-right" class="ml-2 size-4 transition-transform group-hover/cta:translate-x-1" aria-hidden="true" />
        </Link>
      </div>
    </section>
  )}

  {hasError && (
    <section class="mt-8 pt-8">
      <p class="text-muted-foreground text-center">
        Unable to load recent posts. Please try refreshing the page.
      </p>
    </section>
  )}
</Layout>
