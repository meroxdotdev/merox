---
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import { getRecentPosts, getCombinedReadingTime } from '@/lib/data-utils'
import { fetchRecentTracks, type LastFmRecentTrack } from '@/lib/lastfm'
import { formatDate, ensureTrailingSlash } from '@/lib/utils'
import { SOCIAL_LINKS, ICON_MAP, SITE } from '@/consts'
import type { SocialLink } from '@/types'
import { Image } from 'astro:assets'
import heroImageLight from '../assets/meroxindatacenterwhite.webp'
import heroImageDark from '../assets/meroxindatacenterdark.webp'

// Data fetching with error handling
let latestPosts: Awaited<ReturnType<typeof getRecentPosts>> = []
let hasError = false

try {
  latestPosts = await getRecentPosts(SITE.featuredPostCount)
} catch (error) {
  // Log error in development, silent fail in production for graceful degradation
  if (import.meta.env.DEV) {
    console.error('Error fetching recent posts:', error)
  }
  hasError = true
}

// Enrich posts with read time and formatted date for bento carousel
const latestPostsEnriched = await Promise.all(
  latestPosts.map(async (entry) => ({
    entry,
    readTime: await getCombinedReadingTime(entry.id),
    formattedDate: formatDate(entry.data.date),
  }))
)

// Structured data schemas (use light variant as default for crawlers/schema)
const baseUrl = Astro.site?.href ?? SITE.href;
const logoUrl = new URL(heroImageLight.src, baseUrl).href;

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Robert Melcher",
  "alternateName": "merox",
  "url": baseUrl,
  "image": logoUrl,
  "jobTitle": "HPC System Administrator",
  "worksFor": { "@type": "Organization", "name": "Forvia" },
  "sameAs": [
    "https://github.com/meroxdotdev",
    "https://www.linkedin.com/in/robert-melcher-92a1a9157"
  ],
  "description": SITE.description
}

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": SITE.title,
  "url": baseUrl,
  "logo": logoUrl,
  "description": SITE.description,
  "founder": { "@type": "Person", "name": "Robert Melcher" }
}

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE.title,
  "url": baseUrl,
  "description": SITE.description,
  "author": { "@type": "Person", "name": "Robert Melcher" },
  "potentialAction": {
    "@type": "SearchAction",
    "target": { 
      "@type": "EntryPoint", 
      "urlTemplate": `${baseUrl}/blog?q={search_term_string}` 
    },
    "query-input": "required name=search_term_string"
  }
}

// Last.fm recent track (build-time fetch)
// Environment variables: PUBLIC_LASTFM_USERNAME + PUBLIC_LASTFM_API_KEY
// Fallback: LASTFM_USER + LASTFM_API_KEY
// Note: Restart dev server after changing .env
const lastFmUser = (import.meta.env.PUBLIC_LASTFM_USERNAME ?? 
                    import.meta.env.PUBLIC_LASTFM_USER ?? 
                    import.meta.env.LASTFM_USER) as string | undefined
const lastFmApiKey = (import.meta.env.PUBLIC_LASTFM_API_KEY ?? 
                      import.meta.env.LASTFM_API_KEY) as string | undefined

let lastFmTrack: LastFmRecentTrack | null = null
if (lastFmUser?.trim() && lastFmApiKey?.trim()) {
  try {
    const tracks = await fetchRecentTracks(lastFmUser.trim(), lastFmApiKey.trim(), 1)
    lastFmTrack = tracks?.[0] ?? null
  } catch (error) {
    // Silent fail - Last.fm is optional feature
    if (import.meta.env.DEV) {
      console.warn('Failed to fetch Last.fm track:', error)
    }
    lastFmTrack = null
  }
}

---

<Layout class="max-w-4xl" contentPadding="pb-4">
  <PageHead 
    slot="head" 
    title="Merox - Insights from my tech journey" 
    fullTitle={true} 
  >
    <!-- Preload LCP hero images (theme-aware) for fast paint -->
    <link rel="preload" as="image" href={heroImageLight.src}>
    <link rel="preload" as="image" href={heroImageDark.src}>
  </PageHead>

  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  
  <style>
    @font-face {
      font-family: 'Love';
      src: url('/fonts/GABRWFFR.TTF') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* ── Apple-level typography scale (2026) ── */
    .hero-section {
      --bento-gap: 1.25rem;           /* mobile: compact but clear */
      --bento-inner: 1.25rem;        /* default content inset */
      --bento-inner-lg: 1.5rem;     /* hero blocks (identity, quote) */
      --ease-apple: cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Apple's signature easing */
      --ease-apple-smooth: cubic-bezier(0.4, 0.0, 0.2, 1); /* Material Design inspired, Apple refined */
      
      /* Animation delays (in milliseconds) */
      --delay-identity: 0;
      --delay-quote: 160;
      --delay-connect: 240;
      --delay-insight: 300;
      --delay-bike: 360;
      
      /* Status indicator color (green) - uses additive color from theme */
      --status-indicator-color: var(--additive, hsl(142 50% 45%));
      
      /* Combined identity card specific sizing */
      --identity-image-size: 340px;
      --identity-content-flex: 1.4;
      --identity-gap-desktop: 2.5rem;
      --identity-image-offset: 0.5rem;
      
      /* Connect card sizing */
      --connect-gap: 0.875rem;
      --connect-link-gap: 0.625rem;
      --connect-link-padding-y: 0.625rem;
      --connect-link-padding-x: 0.875rem;
      --connect-link-min-height: 2.5rem;
      --connect-link-border-radius: 0.75rem;
      --connect-icon-size: 1.25rem;
    }

    @media (min-width: 768px) {
      .hero-section {
        --bento-gap: 1.75rem;       /* desktop: more air between panels (2026 trend) */
      }
    }

    .bento-grid {
      display: grid;
      gap: var(--bento-gap);
      grid-template-columns: 1fr;
    }

    /* Stagger delay for entrance animation (all viewports) */
    .bento-identity { --delay: var(--delay-identity); }
    .bento-quote    { --delay: var(--delay-quote); }
    .bento-connect  { --delay: var(--delay-connect); }
    .bento-insight  { --delay: var(--delay-insight); }
    .bento-bike     { --delay: var(--delay-bike); }

    @media (min-width: 768px) {
      .bento-grid {
        grid-template-columns: 5fr 3fr 4fr;
        grid-template-rows: auto auto auto;
      }

      .bento-identity   { grid-column: 1 / 4; grid-row: 1; }
      .bento-quote      { grid-column: 1;     grid-row: 2; }
      .bento-insight    { grid-column: 2 / 4; grid-row: 2; min-height: 10rem; }
      .bento-connect    { grid-column: 1 / 3; grid-row: 3; }
      .bento-bike       { grid-column: 3;     grid-row: 3; }
    }

    /* ── Card: Apple-level polish (2026) ── */
    .bento-card {
      padding: var(--bento-inner);
      border-radius: 16px; /* Slightly more rounded for modern feel */
      border: 1px solid color-mix(in srgb, var(--border) 55%, transparent);
      background: color-mix(in srgb, var(--background) 95%, var(--muted) 5%);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      /* Refined shadow system: subtle depth with Apple-like precision */
      box-shadow:
        inset 1px 1px 0 0 color-mix(in srgb, white 8%, transparent),
        0 1px 3px rgba(0, 0, 0, 0.04),
        0 0.5px 1px rgba(0, 0, 0, 0.02);
      /* Smooth transitions with Apple easing */
      transition: box-shadow 0.3s var(--ease-apple), 
                   border-color 0.25s var(--ease-apple),
                   transform 0.3s var(--ease-apple),
                   background 0.3s var(--ease-apple);
    }

    /* Hero blocks: more breath */
    .bento-quote {
      padding: var(--bento-inner-lg);
    }

    /* Photo: full bleed, no inset — panel reads as “different” */
    /* Combined identity card: flex layout for text + image */
    .bento-identity {
      padding: var(--bento-inner-lg);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .bento-identity {
        flex-direction: row;
        align-items: flex-start;
        gap: var(--identity-gap-desktop);
      }
    }

    .bento-identity__content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 768px) {
      .bento-identity__content {
        flex: var(--identity-content-flex);
        min-width: 0;
      }
    }

    .bento-identity__image {
      flex-shrink: 0;
      width: 100%;
      max-width: var(--identity-image-size);
      height: var(--identity-image-size);
      position: relative;
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      .bento-identity__image {
        margin: 0;
        width: var(--identity-image-size);
        height: var(--identity-image-size);
        align-self: flex-start;
        margin-top: var(--identity-image-offset);
      }
    }
    /* Hero image: explicit frame (90% size, offset 6% right / 8% down); both theme images fill it */
    .bento-identity__image .hero-img-inner {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .bento-identity__image .hero-img-frame {
      position: absolute;
      left: 6%;
      top: 8%;
      width: 90%;
      height: 90%;
    }
    .bento-identity__image .hero-img-frame img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
    }

    /* Enhanced hover state with Apple-like micro-interaction */
    @media (prefers-reduced-motion: no-preference) {
      .bento-card:hover {
        transform: translateY(-1px); /* Subtle lift */
        box-shadow:
          inset 1px 1px 0 0 color-mix(in srgb, white 12%, transparent),
          0 4px 16px rgba(0, 0, 0, 0.08),
          0 2px 4px rgba(0, 0, 0, 0.04);
        border-color: color-mix(in srgb, var(--border) 75%, transparent);
      }
      
      .bento-card:active {
        transform: translateY(0);
        transition-duration: 0.15s;
      }
    }
    
    /* Focus state for keyboard navigation */
    .bento-card:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
      box-shadow:
        inset 1px 1px 0 0 color-mix(in srgb, white 8%, transparent),
        0 0 0 4px color-mix(in srgb, var(--ring) 20%, transparent),
        0 1px 3px rgba(0, 0, 0, 0.04);
    }

    /* Dark mode: neutral colors without blue tint - Apple-like elegance */
    :global(html[data-theme="dark"]) .bento-card {
      background: color-mix(in srgb, var(--background) 98%, var(--muted) 2%);
      border-color: color-mix(in srgb, var(--border) 60%, transparent);
      backdrop-filter: blur(20px) saturate(100%); /* Reduced saturation for neutral look */
      -webkit-backdrop-filter: blur(20px) saturate(100%);
      box-shadow:
        inset 1px 1px 0 0 rgba(255, 255, 255, 0.04),
        0 1px 3px rgba(0, 0, 0, 0.4),
        0 0.5px 1px rgba(0, 0, 0, 0.3);
    }
    :global(html[data-theme="dark"]) .bento-card:hover {
      background: color-mix(in srgb, var(--background) 96%, var(--muted) 4%);
      transform: translateY(-1px);
      box-shadow:
        inset 1px 1px 0 0 rgba(255, 255, 255, 0.06),
        0 4px 16px rgba(0, 0, 0, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.35);
      border-color: color-mix(in srgb, var(--border) 70%, transparent);
    }
    :global(html[data-theme="dark"]) .bento-card:active {
      transform: translateY(0);
      background: color-mix(in srgb, var(--background) 97%, var(--muted) 3%);
    }

    /* ── Connect card: modern minimal design (2026) ── */
    .connect-card {
      display: flex;
      flex-direction: column;
      gap: var(--connect-gap);
      padding: var(--bento-inner);
    }

    .connect-card__header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .connect-card__title {
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
      font-size: 0.65625rem;
      letter-spacing: 0.02em;
      color: var(--muted-foreground);
      text-transform: uppercase;
    }

    .connect-card__links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--connect-link-gap);
    }

    @media (min-width: 768px) {
      .connect-card__links {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .connect-card__link {
      display: flex;
      align-items: center;
      gap: var(--connect-link-gap);
      padding: var(--connect-link-padding-y) var(--connect-link-padding-x);
      min-height: var(--connect-link-min-height);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--foreground);
      text-decoration: none;
      border-radius: var(--connect-link-border-radius);
      border: 1px solid color-mix(in srgb, var(--border) 40%, transparent);
      background: color-mix(in srgb, var(--muted) 20%, transparent);
      transition: all 0.25s var(--ease-apple);
      position: relative;
      overflow: hidden;
    }

    .connect-card__link::before {
      content: '';
      position: absolute;
      inset: 0;
      background: color-mix(in srgb, var(--primary) 8%, transparent);
      opacity: 0;
      transition: opacity 0.25s var(--ease-apple);
    }

    .connect-card__link:hover {
      color: var(--primary);
      border-color: color-mix(in srgb, var(--primary) 40%, transparent);
      background: color-mix(in srgb, var(--primary) 6%, transparent);
      transform: translateY(-1px);
    }

    .connect-card__link:hover::before {
      opacity: 1;
    }

    .connect-card__link:active {
      transform: translateY(0);
      transition-duration: 0.1s;
    }

    .connect-card__link:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
      border-color: var(--ring);
    }

    .connect-card__link-content {
      display: flex;
      align-items: center;
      gap: var(--connect-link-gap);
      position: relative;
      z-index: 1;
      width: 100%;
    }

    .connect-card__link-icon {
      flex-shrink: 0;
      width: var(--connect-icon-size);
      height: var(--connect-icon-size);
      color: var(--muted-foreground);
      transition: color 0.25s var(--ease-apple), transform 0.25s var(--ease-apple);
    }

    .connect-card__link:hover .connect-card__link-icon {
      color: var(--primary);
      transform: scale(1.1);
    }

    .connect-card__link-label {
      flex: 1;
      min-width: 0;
    }

    .connect-card__email {
      margin-top: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid color-mix(in srgb, var(--border) 40%, transparent);
    }

    .connect-card__email-link {
      display: inline-flex;
      align-items: center;
      gap: var(--connect-link-gap);
      padding: var(--connect-link-padding-y) var(--connect-link-padding-x);
      min-height: var(--connect-link-min-height);
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--foreground);
      text-decoration: none;
      border-radius: var(--connect-link-border-radius);
      border: 1px solid color-mix(in srgb, var(--primary) 30%, transparent);
      background: color-mix(in srgb, var(--primary) 8%, transparent);
      transition: all 0.25s var(--ease-apple);
      position: relative;
      overflow: hidden;
    }

    .connect-card__email-link::before {
      content: '';
      position: absolute;
      inset: 0;
      background: color-mix(in srgb, var(--primary) 12%, transparent);
      opacity: 0;
      transition: opacity 0.25s var(--ease-apple);
    }

    .connect-card__email-link:hover {
      color: var(--primary);
      border-color: color-mix(in srgb, var(--primary) 50%, transparent);
      background: color-mix(in srgb, var(--primary) 10%, transparent);
      transform: translateY(-1px);
    }

    .connect-card__email-link:hover::before {
      opacity: 1;
    }

    .connect-card__email-link:active {
      transform: translateY(0);
      transition-duration: 0.1s;
    }

    .connect-card__email-link:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
      border-color: var(--ring);
    }

    .connect-card__email-icon {
      flex-shrink: 0;
      width: var(--connect-icon-size);
      height: var(--connect-icon-size);
      color: var(--primary);
      transition: transform 0.25s var(--ease-apple);
    }

    .connect-card__email-link:hover .connect-card__email-icon {
      transform: scale(1.1);
    }

    /* ── Particle cards: single accent bar + typography (2026 minimal) ── */
    .particle-card {
      border-left: 3px solid color-mix(in srgb, var(--primary) 35%, transparent);
      transition: border-left-color 0.4s var(--ease-apple),
                  transform 0.3s var(--ease-apple);
    }

    .particle-card:hover {
      border-left-color: color-mix(in srgb, var(--primary) 70%, transparent);
      transform: translateX(2px); /* Subtle slide on hover */
    }
    
    .particle-card:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }

    .particle-card .particle-title {
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .particle-card .particle-tagline {
      font-size: 0.75rem;
      color: var(--muted-foreground);
      letter-spacing: 0.01em;
    }

    .particle-card .particle-tagline::before {
      content: '· ';
      color: color-mix(in srgb, var(--primary) 50%, var(--muted-foreground));
      font-weight: 600;
    }

    /* ── Latest played (Last.fm) card: full-card texture ── */
    .lastfm-card .particle-tagline::before {
      content: none;
    }
    .lastfm-card {
      --lastfm-line: color-mix(in srgb, var(--primary) 26%, transparent);
      border-left: none;
      position: relative;
      overflow: hidden;
      padding: var(--bento-inner);
    }
    .lastfm-card:hover {
      --lastfm-line: color-mix(in srgb, var(--primary) 42%, transparent);
    }
    /* Faded accent line at edges - smooth gradient fade */
    .lastfm-card::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      z-index: 0;
      pointer-events: none;
      border-radius: inherit;
      background: linear-gradient(
        to bottom,
        transparent 0%,
        var(--lastfm-line) 18%,
        var(--lastfm-line) 50%,
        var(--lastfm-line) 82%,
        transparent 100%
      );
    }
    /* Mesh gradient minimalist: doar nuanțe soft în colțuri, fără puncte/linii */
    .lastfm-card::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      border-radius: inherit;
      pointer-events: none;
      background-image:
        radial-gradient(ellipse 100% 80% at 0% 100%, color-mix(in srgb, var(--primary) 14%, transparent) 0%, transparent 60%),
        radial-gradient(ellipse 80% 100% at 100% 0%, color-mix(in srgb, var(--foreground) 8%, transparent) 0%, transparent 55%);
      background-size: 100% 100%;
    }
    .lastfm-card > * {
      position: relative;
      z-index: 1;
    }
    .lastfm-track-name {
      font-size: 0.8125rem;
      font-weight: 600;
      line-height: 1.3;
      color: var(--foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .lastfm-artist {
      display: block;
      font-size: 0.75rem;
      color: var(--muted-foreground);
      margin-top: 0.125rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lastfm-now {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--primary);
      margin-left: 0.375rem;
    }
    .lastfm-now-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 0 0 color-mix(in srgb, var(--primary) 40%, transparent);
    }
    @media (prefers-reduced-motion: no-preference) {
      .lastfm-now-dot {
        animation: lastfm-pulse 1.8s var(--ease-apple) infinite;
      }
    }
    @keyframes lastfm-pulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.5; 
        transform: scale(1.2);
      }
    }

    /* ── Latest Insights carousel (bento) ── */
    .bento-insight {
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: var(--bento-inner-lg);
    }


    .insight-carousel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .insight-carousel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .insight-carousel-nav {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .insight-carousel-nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem; /* Increased for better touch target */
      height: 2.5rem;
      min-width: 2.5rem; /* Ensure minimum size */
      min-height: 2.5rem;
      border-radius: 0.625rem; /* More rounded */
      border: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
      background: color-mix(in srgb, var(--muted) 40%, transparent);
      color: var(--muted-foreground);
      cursor: pointer;
      transition: border-color 0.25s var(--ease-apple), 
                  background 0.25s var(--ease-apple), 
                  color 0.25s var(--ease-apple),
                  transform 0.2s var(--ease-apple);
      position: relative;
    }

    .insight-carousel-nav-btn:hover:not(:disabled) {
      border-color: color-mix(in srgb, var(--primary) 50%, transparent);
      background: color-mix(in srgb, var(--primary) 12%, transparent);
      color: var(--foreground);
      transform: scale(1.05); /* Subtle scale on hover */
    }
    
    .insight-carousel-nav-btn:active:not(:disabled) {
      transform: scale(0.98);
      transition-duration: 0.1s;
    }

    .insight-carousel-nav-btn:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
      background: color-mix(in srgb, var(--ring) 15%, transparent);
    }

    .insight-carousel-nav-btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      pointer-events: none;
    }

    .insight-carousel-track {
      position: relative;
      flex: 1;
      min-height: 7.5rem;
      /* Smooth scrolling for touch devices */
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .insight-slide {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
    }

    @media (prefers-reduced-motion: no-preference) {
      .insight-slide {
        transition: opacity 0.35s var(--ease-apple-smooth), 
                    visibility 0.35s var(--ease-apple-smooth),
                    transform 0.35s var(--ease-apple-smooth);
        transform: translateX(8px);
      }
      
      .insight-slide[data-visible="true"] {
        transform: translateX(0);
      }
    }

    .insight-slide[data-visible="true"] {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* Decorative index (01, 02, 03) */
    .insight-slide-number {
      position: absolute;
      top: -0.15rem;
      right: 0;
      font-size: 4rem;
      font-weight: 800;
      line-height: 1;
      color: color-mix(in srgb, var(--foreground) 4%, transparent);
      user-select: none;
      pointer-events: none;
    }

    [data-theme='dark'] .insight-slide-number {
      color: color-mix(in srgb, var(--foreground) 6%, transparent);
    }

    .insight-slide-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.25rem 0;
      min-height: 5rem;
      user-select: none;
    }

    .insight-slide-title-link {
      text-decoration: none;
      transition: color 0.25s var(--ease-apple);
      display: block;
      border-radius: 0.375rem;
      padding: 0.25rem 0;
      margin: -0.25rem 0;
    }

    .insight-slide-title {
      font-size: clamp(0.875rem, 0.8125rem + 0.25vw, 0.9375rem); /* Responsive font size */
      font-weight: 600;
      line-height: 1.4; /* Slightly increased for better readability */
      letter-spacing: -0.01em; /* Tighter letter spacing for modern feel */
      color: var(--foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.25s var(--ease-apple);
    }

    .insight-slide-title-link:hover .insight-slide-title {
      color: var(--primary);
    }
    
    .insight-slide-title-link:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 4px;
      border-radius: 0.5rem;
    }

    .insight-slide-desc {
      font-size: 0.75rem;
      line-height: 1.4;
      color: var(--muted-foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .insight-slide-meta {
      font-size: 0.6875rem;
      color: var(--muted-foreground);
      margin-top: auto;
      padding-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .insight-carousel-footer {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid color-mix(in srgb, var(--border) 40%, transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
    }


    /* ── Skip link for accessibility ── */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    .sr-only:focus {
      position: fixed;
      width: auto;
      height: auto;
      padding: 0.75rem 1rem;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
      background: var(--primary);
      color: var(--primary-foreground);
      border-radius: 0.5rem;
      z-index: 9999;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ── Identity role line (minimal, left-aligned with content below) ── */
    /* ── Panel title style (shared across all cards) ── */
    .panel-title {
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
      font-size: 0.65625rem;
      letter-spacing: 0.02em;
      color: var(--muted-foreground);
    }

    .identity-role {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }
    .identity-role__dot {
      position: relative;
      flex-shrink: 0;
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--status-indicator-color);
      box-shadow: 0 0 0 0 color-mix(in srgb, var(--status-indicator-color) 40%, transparent);
    }
    .identity-role__dot::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: var(--identity-dot-color);
      opacity: 0.5;
    }
    @media (prefers-reduced-motion: no-preference) {
      .identity-role__dot::before {
        animation: identity-dot-pulse 2s var(--ease-apple) infinite;
      }
      .identity-role__dot {
        animation: identity-dot-glow 2s var(--ease-apple) infinite;
      }
    }
    @keyframes identity-dot-pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(2); opacity: 0; }
    }
    @keyframes identity-dot-glow {
      0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--status-indicator-color) 40%, transparent); }
      50% { box-shadow: 0 0 0 4px color-mix(in srgb, var(--status-indicator-color) 0%, transparent); }
    }
    .identity-role__sep {
      margin: 0 0.4em;
      color: color-mix(in srgb, var(--muted-foreground) 50%, transparent);
    }

    /* ── Staggered card entrance with Apple-like animation ── */
    @media (prefers-reduced-motion: no-preference) {
      .bento-card {
        animation: bentoFadeIn 0.7s var(--ease-apple-smooth) both;
        animation-delay: calc(var(--delay, 0) * 1ms);
        opacity: 0; /* Start hidden for animation */
      }

      @keyframes bentoFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.96);
          filter: blur(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
          filter: blur(0);
        }
      }
    }
    
    /* Ensure cards are visible if animations are disabled */
    @media (prefers-reduced-motion: reduce) {
      .bento-card {
        opacity: 1;
        animation: none;
      }
    }
  </style>

  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-primary focus:text-primary-foreground focus:rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
    Skip to main content
  </a>

  <section class="hero-section relative pt-6 pb-4 md:pt-10 md:pb-6" id="hero">
    <!-- Bento grid -->
    <div class="bento-grid">

      <!-- Identity card: combined with photo -->
      <div class="bento-card bento-identity">
        <div class="bento-identity__content">
          <p class="identity-role panel-title" aria-label="HPC System Administrator at Forvia">
            <span class="identity-role__dot" aria-hidden="true"></span>
            HPC System Administrator<span class="identity-role__sep" aria-hidden="true">/</span>Forvia
          </p>
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tighter uppercase leading-[0.92] break-words">
            Building<br />infrastructure<br /><span class="text-primary transition-colors duration-300">that scales</span>.
          </h1>
          <p class="mt-4 text-sm md:text-[15px] text-muted-foreground/75 max-w-md leading-relaxed">
            Technical blog on infrastructure, homelab, and automation — and the person behind it. For people who run systems.
          </p>
          <div class="flex flex-wrap items-center gap-4 mt-6">
            <Link href="/blog" class="btn-neo-primary" aria-label="Read the blog">
              Read the blog
              <Icon name="lucide:arrow-right" class="btn-neo-icon" aria-hidden="true" />
            </Link>
            <Link href="/about" class="btn-neo-outline" aria-label="About me">
              <Icon name="lucide:user" class="btn-neo-icon" aria-hidden="true" />
              About me
            </Link>
          </div>
        </div>
        <!-- Photo: one frame (90%, offset), both theme images fill it — same layout light/dark -->
        <div class="bento-identity__image overflow-hidden relative">
          <div class="hero-img-inner relative w-full h-full">
            <div class="hero-img-frame">
              <Image
                src={heroImageLight}
                alt="Robert Melcher in datacenter"
                widths={[300, 500, 600, heroImageLight.width]}
                sizes="(max-width: 768px) 100vw, 340px"
                loading="eager"
                fetchpriority="high"
                class="absolute inset-0 w-full h-full object-contain object-center dark:opacity-0 dark:pointer-events-none"
              />
              <Image
                src={heroImageDark}
                alt="Robert Melcher in datacenter"
                widths={[300, 500, 600, heroImageDark.width]}
                sizes="(max-width: 768px) 100vw, 340px"
                loading="eager"
                fetchpriority="high"
                class="absolute inset-0 w-full h-full object-contain object-center opacity-0 pointer-events-none dark:opacity-100 dark:pointer-events-auto"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Quote card -->
      <div class="bento-card bento-quote flex items-center" tabindex="0" role="note" aria-label="Quote">
        <blockquote class="text-lg md:text-xl italic leading-relaxed text-foreground/90">
          <span class="text-primary/60 not-italic">&ldquo;</span>Works in theory &mdash;<br />now let&rsquo;s see what <span class="text-foreground font-semibold not-italic">doesn&rsquo;t</span><span class="text-primary/60 not-italic">&rdquo;</span>
        </blockquote>
      </div>

      <!-- Latest Insights carousel -->
      <div class="bento-card bento-insight">
        <div class="insight-carousel">
          <div class="insight-carousel-header">
            <span class="panel-title uppercase">Latest Insights</span>
            {latestPostsEnriched.length > 1 ? (
              <nav class="insight-carousel-nav" aria-label="Navigate insights">
                <button 
                  type="button" 
                  id="insight-prev" 
                  class="insight-carousel-nav-btn" 
                  aria-label="Previous insight" 
                  disabled={latestPostsEnriched.length <= 1}
                  aria-keyshortcuts="ArrowLeft"
                >
                  <Icon name="lucide:chevron-left" class="size-4" aria-hidden="true" />
                </button>
                <button 
                  type="button" 
                  id="insight-next" 
                  class="insight-carousel-nav-btn" 
                  aria-label="Next insight" 
                  disabled={latestPostsEnriched.length <= 1}
                  aria-keyshortcuts="ArrowRight"
                >
                  <Icon name="lucide:chevron-right" class="size-4" aria-hidden="true" />
                </button>
              </nav>
            ) : null}
          </div>
          {latestPostsEnriched.length > 0 ? (
            <div 
              class="insight-carousel-track" 
              id="insight-track" 
              aria-live="polite" 
              aria-atomic="true"
              tabindex="0"
              role="region"
              aria-label="Latest insights carousel"
            >
              {latestPostsEnriched.map(({ entry, readTime, formattedDate }, i) => (
                <div
                  class="insight-slide"
                  data-visible={i === 0 ? 'true' : 'false'}
                  data-index={i}
                  role="group"
                  aria-roledescription="slide"
                  aria-label={`Insight ${i + 1} of ${latestPostsEnriched.length}`}
                  aria-hidden={i !== 0}
                  hidden={i !== 0}
                >
                  <span class="insight-slide-number" aria-hidden="true">{String(i + 1).padStart(2, '0')}</span>
                  <div class="insight-slide-content">
                    <Link href={ensureTrailingSlash(`/blog/${entry.id}`)} class="insight-slide-title-link">
                      <span class="insight-slide-title">{entry.data.title}</span>
                    </Link>
                    {entry.data.description ? (
                      <span class="insight-slide-desc">{entry.data.description}</span>
                    ) : null}
                    <span class="insight-slide-meta">
                      <time datetime={entry.data.date.toISOString()}>{formattedDate}</time>
                      <span aria-hidden="true">·</span>
                      <span>{readTime}</span>
                    </span>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="insight-carousel-track flex items-center justify-center min-h-[5rem]">
              <p class="text-sm text-muted-foreground/80">No posts yet.</p>
            </div>
          )}
          <div class="insight-carousel-footer">
            <Link href="/blog" class="text-xs font-medium text-muted-foreground hover:text-primary transition-colors inline-flex items-center gap-1">
              {latestPostsEnriched.length > 0 ? 'Explore all posts' : 'Go to blog'}
              <Icon name="lucide:arrow-right" class="size-3" aria-hidden="true" />
            </Link>
          </div>
        </div>
      </div>

      <!-- Connect card: modern minimal design -->
      <div class="bento-card bento-connect connect-card">
        <div class="connect-card__header">
          <span class="connect-card__title">Get In Touch</span>
        </div>
        <nav class="connect-card__links" aria-label="Social and contact links">
          {SOCIAL_LINKS.filter(({ label }) => label !== 'Email').map(({ href, label }: SocialLink) => (
            <Link href={href} aria-label={label} title={label} class="connect-card__link">
              <span class="connect-card__link-content">
                <Icon
                  name={ICON_MAP[label as keyof typeof ICON_MAP] || 'lucide:link'}
                  class="connect-card__link-icon"
                  aria-hidden="true"
                />
                <span class="connect-card__link-label">{label}</span>
              </span>
            </Link>
          ))}
        </nav>
        <div class="connect-card__email">
          <a href="mailto:hello@merox.dev" class="connect-card__email-link" aria-label="Email hello@merox.dev">
            <Icon name="lucide:mail" class="connect-card__email-icon" aria-hidden="true" />
            hello@merox.dev
          </a>
        </div>
      </div>

      <!-- Latest played (Last.fm) -->
      <div class="bento-card particle-card lastfm-card bento-bike flex items-center gap-3 group/lastfm" tabindex="0" role="region" aria-label="Latest played track">
        <div class="min-w-0 flex-1 relative z-[1]">
          <span class="panel-title uppercase">Latest played</span>
          {lastFmTrack ? (
            <a
              href={lastFmTrack.url}
              target="_blank"
              rel="noopener noreferrer"
              class="block mt-1 group/link focus-visible:outline-2 focus-visible:outline focus-visible:outline-ring focus-visible:outline-offset-2 focus-visible:rounded"
              aria-label={`${lastFmTrack.name} by ${lastFmTrack.artist}${lastFmTrack.nowPlaying ? ' - Now playing' : ''}`}
            >
              <span class="lastfm-track-name group-hover/link:text-primary transition-colors">{lastFmTrack.name}</span>
              <span class="lastfm-artist">{lastFmTrack.artist}</span>
              {lastFmTrack.nowPlaying ? (
                <span class="lastfm-now" aria-label="Now playing">
                  <span class="lastfm-now-dot" aria-hidden="true"></span>
                  Now
                </span>
              ) : null}
            </a>
          ) : (
            <p class="mt-1 text-sm text-muted-foreground">Nothing playing</p>
          )}
        </div>
        {lastFmTrack && (
          <Icon name="lucide:external-link" class="size-3.5 flex-shrink-0 text-muted-foreground/50 group-hover/lastfm:text-primary/70 transition-colors" aria-hidden="true" />
        )}
      </div>
    </div>
  </section>


  {hasError && (
    <section class="mt-8 pt-8">
      <p class="text-muted-foreground text-center">
        Unable to load recent posts. Please try refreshing the page.
      </p>
    </section>
  )}

  {latestPostsEnriched.length > 1 && (
    <script define:vars={{ slideCount: latestPostsEnriched.length }} is:inline>
      (function () {
        'use strict';
        
        const SWIPE_THRESHOLD = 50;
        
        const track = document.getElementById('insight-track');
        const prevBtn = document.getElementById('insight-prev');
        const nextBtn = document.getElementById('insight-next');
        
        if (!track || !prevBtn || !nextBtn) return;

        const slides = track.querySelectorAll('.insight-slide');
        let current = 0;
        let touchStartX = 0;
        let touchEndX = 0;

        function goTo(index, direction = 'next') {
          const prevIndex = current;
          current = (index + slideCount) % slideCount;
          
          // Update slides with smooth transition
          slides.forEach((el, i) => {
            const visible = i === current;
            el.setAttribute('data-visible', visible ? 'true' : 'false');
            el.setAttribute('aria-hidden', String(!visible));
            el.toggleAttribute('hidden', !visible);
            
            // Add direction class for animation
            if (visible && i !== prevIndex) {
              el.setAttribute('data-direction', direction);
            }
          });
          
          // Update button states
          prevBtn.disabled = current === 0;
          nextBtn.disabled = current === slideCount - 1;
          
          // Announce change to screen readers
          const currentSlide = slides[current];
          if (currentSlide) {
            const title = currentSlide.querySelector('.insight-slide-title')?.textContent || '';
            track.setAttribute('aria-label', `Showing insight ${current + 1} of ${slideCount}: ${title}`);
          }
        }
        
        function handleSwipe() {
          const diff = touchStartX - touchEndX;
          if (Math.abs(diff) > SWIPE_THRESHOLD) {
            if (diff > 0 && current < slideCount - 1) {
              // Swipe left - next
              goTo(current + 1, 'next');
            } else if (diff < 0 && current > 0) {
              // Swipe right - previous
              goTo(current - 1, 'prev');
            }
          }
        }
        
        // Initialize
        goTo(0);

        // Button clicks
        prevBtn.addEventListener('click', () => goTo(current - 1, 'prev'));
        nextBtn.addEventListener('click', () => goTo(current + 1, 'next'));
        
        // Keyboard navigation (Arrow keys, Home, End)
        track.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft' && current > 0) {
            e.preventDefault();
            goTo(current - 1, 'prev');
            prevBtn.focus();
          } else if (e.key === 'ArrowRight' && current < slideCount - 1) {
            e.preventDefault();
            goTo(current + 1, 'next');
            nextBtn.focus();
          } else if (e.key === 'Home') {
            e.preventDefault();
            goTo(0, 'prev');
          } else if (e.key === 'End') {
            e.preventDefault();
            goTo(slideCount - 1, 'next');
          }
        });
        
        // Touch swipe support
        track.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        track.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        }, { passive: true });
      })();
    </script>
  )}

</Layout>
