---
import '@/styles/index.css'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { getRecentPosts, getCombinedReadingTime } from '@/lib/data-utils'
import { fetchRecentTracks, type LastFmRecentTrack } from '@/lib/lastfm'
import { formatDate } from '@/lib/utils'
import { SITE, PERSON } from '@/consts'
import { createHomepageSchemas } from '@/lib/schemas'
import heroImageLight from '../assets/t1.webp'
import heroImageDark from '../assets/t2.webp'
import IdentityCard from '@/components/home/IdentityCard.astro'
import FileTreeCard from '@/components/home/FileTreeCard.astro'
import InsightCarousel from '@/components/home/InsightCarousel.astro'
import ConnectCard from '@/components/home/ConnectCard.astro'
import LastFmCard from '@/components/home/LastFmCard.astro'

// Data fetching with error handling
let latestPosts: Awaited<ReturnType<typeof getRecentPosts>> = []
let hasError = false

try {
  latestPosts = await getRecentPosts(SITE.featuredPostCount)
} catch (error) {
  // Log error in development, silent fail in production for graceful degradation
  if (import.meta.env.DEV) {
    console.error('Error fetching recent posts:', error)
  }
  hasError = true
}

// Enrich posts with read time and formatted date for bento carousel
const latestPostsEnriched = await Promise.all(
  latestPosts.map(async (entry) => ({
    entry,
    readTime: await getCombinedReadingTime(entry.id),
    formattedDate: formatDate(entry.data.date),
  }))
)

// Structured data schemas (use light variant as default for crawlers/schema)
const baseUrl = Astro.site?.href ?? SITE.href
// Use the image src directly for logo (Astro will optimize it)
const logoUrl = new URL(heroImageLight.src, baseUrl).href

const schemas = createHomepageSchemas(
  SITE,
  baseUrl,
  logoUrl,
  PERSON.name,
  PERSON.alternateName,
  PERSON.jobTitle,
  PERSON.worksFor,
  PERSON.sameAs
)

// Last.fm recent track (build-time fetch)
// Environment variables: PUBLIC_LASTFM_USERNAME + PUBLIC_LASTFM_API_KEY
// Note: Restart dev server after changing .env
const lastFmUser = import.meta.env.PUBLIC_LASTFM_USERNAME?.trim()
const lastFmApiKey = import.meta.env.PUBLIC_LASTFM_API_KEY?.trim()

let lastFmTrack: LastFmRecentTrack | null = null
if (lastFmUser && lastFmApiKey) {
  try {
    const tracks = await fetchRecentTracks(lastFmUser, lastFmApiKey, 1)
    lastFmTrack = tracks?.[0] ?? null
  } catch (error) {
    // Silent fail - Last.fm is optional feature
    if (import.meta.env.DEV) {
      console.warn('Failed to fetch Last.fm track:', error)
    }
    lastFmTrack = null
  }
}

---

<Layout class="max-w-4xl" contentPadding="pb-4">
  <PageHead slot="head" title="Merox - Insights from my tech journey" fullTitle={true}>
    <!-- Hero image is preloaded via Astro Image component with loading="eager" -->
  </PageHead>

  <script type="application/ld+json" set:html={JSON.stringify(schemas.person)} />
  <script type="application/ld+json" set:html={JSON.stringify(schemas.organization)} />
  <script type="application/ld+json" set:html={JSON.stringify(schemas.website)} />

  <section class="hero-section relative pt-6 pb-4 md:pt-10 md:pb-6" id="hero">
    <!-- Bento grid -->
    <div class="bento-grid">
      <!-- Identity card: combined with photo -->
      <IdentityCard
        jobTitle={PERSON.jobTitle}
        worksFor={PERSON.worksFor}
        heroImageLight={heroImageLight}
        heroImageDark={heroImageDark}
      />

      <!-- File tree card -->
      <FileTreeCard />

      <!-- Latest Insights carousel -->
      <InsightCarousel posts={latestPostsEnriched} />

      <!-- Connect card: modern minimal design -->
      <ConnectCard />

      <!-- Latest played (Last.fm) -->
      <LastFmCard track={lastFmTrack} />
    </div>
  </section>

  {hasError && (
    <section class="mt-8 pt-8">
      <p class="text-muted-foreground text-center">
        Unable to load recent posts. Please try refreshing the page.
      </p>
    </section>
  )}
</Layout>
