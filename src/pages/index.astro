---
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import { buttonVariants } from '@/components/ui/button'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import { getRecentPosts, getCombinedReadingTime } from '@/lib/data-utils'
import { fetchRecentTracks, type LastFmRecentTrack } from '@/lib/lastfm'
import { formatDate, ensureTrailingSlash } from '@/lib/utils'
import { SOCIAL_LINKS, ICON_MAP, SITE } from '@/consts'
import type { SocialLink } from '@/types'
import { Image } from 'astro:assets'
import heroImageLight from '../assets/meroxindatacenterwhite.webp'
import heroImageDark from '../assets/meroxindatacenterdark.webp'

// Data fetching with error handling
let latestPosts: Awaited<ReturnType<typeof getRecentPosts>> = []
let hasError = false

try {
  latestPosts = await getRecentPosts(SITE.featuredPostCount)
} catch (error) {
  console.error('Error fetching recent posts:', error)
  hasError = true
}

// Enrich posts with read time and formatted date for bento carousel
const latestPostsEnriched = await Promise.all(
  latestPosts.map(async (entry) => ({
    entry,
    readTime: await getCombinedReadingTime(entry.id),
    formattedDate: formatDate(entry.data.date),
  }))
)

// Structured data schemas (use light variant as default for crawlers/schema)
const baseUrl = Astro.site?.href || SITE.href
const logoUrl = new URL(heroImageLight.src, baseUrl).href

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Robert Melcher",
  "alternateName": "merox",
  "url": baseUrl,
  "image": logoUrl,
  "jobTitle": "HPC System Administrator",
  "worksFor": { "@type": "Organization", "name": "Forvia" },
  "sameAs": [
    "https://github.com/meroxdotdev",
    "https://www.linkedin.com/in/robert-melcher-92a1a9157"
  ],
  "description": SITE.description
}

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": SITE.title,
  "url": baseUrl,
  "logo": logoUrl,
  "description": SITE.description,
  "founder": { "@type": "Person", "name": "Robert Melcher" }
}

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE.title,
  "url": baseUrl,
  "description": SITE.description,
  "author": { "@type": "Person", "name": "Robert Melcher" },
  "potentialAction": {
    "@type": "SearchAction",
    "target": { 
      "@type": "EntryPoint", 
      "urlTemplate": `${baseUrl}/blog?q={search_term_string}` 
    },
    "query-input": "required name=search_term_string"
  }
}

// Last.fm recent track (build-time fetch). In .env use PUBLIC_LASTFM_USERNAME + PUBLIC_LASTFM_API_KEY (or LASTFM_USER + LASTFM_API_KEY). Restart dev server after changing .env.
const lastFmUser = (import.meta.env.PUBLIC_LASTFM_USERNAME ?? import.meta.env.PUBLIC_LASTFM_USER ?? import.meta.env.LASTFM_USER) as string | undefined
const lastFmApiKey = (import.meta.env.PUBLIC_LASTFM_API_KEY ?? import.meta.env.LASTFM_API_KEY) as string | undefined
let lastFmTrack: LastFmRecentTrack | null = null
if (lastFmUser?.trim() && lastFmApiKey?.trim()) {
  try {
    const tracks = await fetchRecentTracks(lastFmUser.trim(), lastFmApiKey.trim(), 1)
    lastFmTrack = tracks?.[0] ?? null
  } catch {
    lastFmTrack = null
  }
}

// Reusable class configurations
const primaryButtonClasses = 'rounded-full px-6 h-11 text-sm font-bold shadow-lg shadow-primary/20 transition-all hover:-translate-y-0.5 active:scale-95'
const outlineButtonClasses = 'rounded-full px-6 h-11 text-sm font-bold transition-all hover:-translate-y-0.5 active:scale-95'
---

<Layout class="max-w-4xl" contentPadding="pb-4">
  <PageHead 
    slot="head" 
    title="Merox - Insights from my tech journey" 
    fullTitle={true} 
  >
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preload LCP hero images (theme-aware) for fast paint -->
    <link rel="preload" as="image" href={heroImageLight.src}>
    <link rel="preload" as="image" href={heroImageDark.src}>
  </PageHead>

  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  
  <style>
    @font-face {
      font-family: 'Love';
      src: url('/fonts/GABRWFFR.TTF') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* ── Dot-grid background ── */
    .hero-grid {
      background-size: 24px 24px;
      mask-image: radial-gradient(ellipse 70% 60% at 50% 40%, black 10%, transparent 100%);
      -webkit-mask-image: radial-gradient(ellipse 70% 60% at 50% 40%, black 10%, transparent 100%);
    }

    .hero-grid::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 50% 70% at 50% 100%, color-mix(in srgb, var(--primary) 4%, transparent) 0%, transparent 100%);
      pointer-events: none;
    }

    [data-theme='dark'] .hero-grid::before {
      background: radial-gradient(ellipse 50% 70% at 50% 100%, color-mix(in srgb, var(--primary) 6%, transparent) 0%, transparent 100%);
    }

    /* ── Bento grid layout ── */
    .bento-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .bento-grid {
        grid-template-columns: 5fr 3fr 4fr;
        grid-template-rows: auto auto auto auto;
        gap: 10px;
      }

      .bento-identity   { grid-column: 1 / 3; grid-row: 1; }   /* wide left */
      .bento-photo      { grid-column: 3;     grid-row: 1; }
      .bento-quote      { grid-column: 1;     grid-row: 2; }
      .bento-connect    { grid-column: 2 / 4; grid-row: 2; }   /* wide right */
      .bento-insight    { grid-column: 1 / 3; grid-row: 3; min-height: 10rem; }  /* carousel */
      .bento-bike       { grid-column: 3;     grid-row: 3; }
      .bento-signature  { grid-column: 1 / -1; grid-row: 4; }  /* full width */
    }

    .bento-signature {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1rem;
      min-height: auto;
    }

    .signature-text {
      font-family: 'Love', cursive;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      color: color-mix(in srgb, var(--foreground) 75%, var(--primary));
    }

    @media (min-width: 768px) {
      .signature-text { font-size: 1.15rem; }
    }

    /* ── Card base ── */
    .bento-card {
      border-radius: 1.125rem;
      border: 1px solid color-mix(in srgb, var(--border) 55%, transparent);
      background: color-mix(in srgb, var(--card) 60%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 1px 3px -1px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04);
      transition: border-color 0.35s ease, box-shadow 0.35s ease, transform 0.35s ease;
    }

    .bento-card:hover {
      border-color: color-mix(in srgb, var(--border) 90%, transparent);
      box-shadow: 0 4px 20px -6px color-mix(in srgb, var(--primary) 12%, transparent),
                  0 1px 3px -1px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    /* ── Social chip ── */
    .social-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.7rem;
      border-radius: 0.6rem;
      font-size: 0.75rem;
      font-weight: 500;
      background: color-mix(in srgb, var(--muted) 60%, transparent);
      border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
      color: color-mix(in srgb, var(--foreground) 88%, var(--muted-foreground));
      transition: all 0.25s ease;
    }

    .social-chip:hover {
      background: color-mix(in srgb, var(--primary) 12%, transparent);
      border-color: color-mix(in srgb, var(--primary) 25%, transparent);
      color: var(--foreground);
    }

    .social-chip:hover .social-chip-icon {
      color: var(--primary);
    }

    /* ── Particle cards: single accent bar + typography (2026 minimal) ── */
    .particle-card {
      border-left: 3px solid color-mix(in srgb, var(--primary) 35%, transparent);
      transition: border-left-color 0.35s ease;
    }

    .particle-card:hover {
      border-left-color: color-mix(in srgb, var(--primary) 70%, transparent);
    }

    .particle-card .particle-title {
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .particle-card .particle-tagline {
      font-size: 0.75rem;
      color: var(--muted-foreground);
      letter-spacing: 0.01em;
    }

    .particle-card .particle-tagline::before {
      content: '· ';
      color: color-mix(in srgb, var(--primary) 50%, var(--muted-foreground));
      font-weight: 600;
    }

    /* ── Latest played (Last.fm) card: full-card texture ── */
    .lastfm-card .particle-tagline::before {
      content: none;
    }
    .lastfm-card {
      border-left-color: color-mix(in srgb, var(--primary) 40%, transparent);
      position: relative;
      overflow: hidden;
    }
    /* Mesh gradient minimalist: doar nuanțe soft în colțuri, fără puncte/linii */
    .lastfm-card::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      border-radius: inherit;
      pointer-events: none;
      background-image:
        radial-gradient(ellipse 100% 80% at 0% 100%, color-mix(in srgb, var(--primary) 14%, transparent) 0%, transparent 60%),
        radial-gradient(ellipse 80% 100% at 100% 0%, color-mix(in srgb, var(--foreground) 8%, transparent) 0%, transparent 55%);
      background-size: 100% 100%;
    }
    .lastfm-card:hover {
      border-left-color: color-mix(in srgb, var(--primary) 65%, transparent);
    }
    .lastfm-card > * {
      position: relative;
      z-index: 1;
    }
    .lastfm-track-name {
      font-size: 0.8125rem;
      font-weight: 600;
      line-height: 1.3;
      color: var(--foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .lastfm-artist {
      display: block;
      font-size: 0.75rem;
      color: var(--muted-foreground);
      margin-top: 0.125rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lastfm-now {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--primary);
      margin-left: 0.375rem;
    }
    .lastfm-now-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--primary);
    }
    @media (prefers-reduced-motion: no-preference) {
      .lastfm-now-dot {
        animation: lastfm-pulse 1.5s ease-in-out infinite;
      }
    }
    @keyframes lastfm-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ── Latest Insight carousel (bento) ── */
    .bento-insight {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .insight-carousel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .insight-carousel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .insight-carousel-nav {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .insight-carousel-nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: 0.5rem;
      border: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
      background: color-mix(in srgb, var(--muted) 40%, transparent);
      color: var(--muted-foreground);
      transition: border-color 0.2s, background 0.2s, color 0.2s;
    }

    .insight-carousel-nav-btn:hover:not(:disabled) {
      border-color: color-mix(in srgb, var(--primary) 40%, transparent);
      background: color-mix(in srgb, var(--primary) 10%, transparent);
      color: var(--foreground);
    }

    .insight-carousel-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .insight-carousel-track {
      position: relative;
      flex: 1;
      min-height: 7.5rem;
    }

    .insight-slide {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
    }

    @media (prefers-reduced-motion: no-preference) {
      .insight-slide {
        transition: opacity 0.25s ease, visibility 0.25s ease;
      }
    }

    .insight-slide[data-visible="true"] {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* Decorative index (01, 02, 03) */
    .insight-slide-number {
      position: absolute;
      top: -0.15rem;
      right: 0;
      font-size: 4rem;
      font-weight: 800;
      line-height: 1;
      color: color-mix(in srgb, var(--foreground) 4%, transparent);
      user-select: none;
      pointer-events: none;
    }

    [data-theme='dark'] .insight-slide-number {
      color: color-mix(in srgb, var(--foreground) 6%, transparent);
    }

    .insight-slide-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.25rem 0;
      min-height: 5rem;
      user-select: none;
    }

    .insight-slide-title-link {
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .insight-slide-title {
      font-size: 0.9375rem;
      font-weight: 600;
      line-height: 1.3;
      color: var(--foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .insight-slide-title-link:hover .insight-slide-title {
      color: var(--primary);
    }

    .insight-slide-desc {
      font-size: 0.75rem;
      line-height: 1.4;
      color: var(--muted-foreground);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .insight-slide-meta {
      font-size: 0.6875rem;
      color: var(--muted-foreground);
      margin-top: auto;
      padding-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .insight-carousel-footer {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid color-mix(in srgb, var(--border) 40%, transparent);
    }

    /* ── Staggered card entrance ── */
    @media (prefers-reduced-motion: no-preference) {
      .bento-card {
        animation: bentoFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
        animation-delay: calc(var(--delay, 0) * 1ms);
      }

      @keyframes bentoFadeIn {
        from {
          opacity: 0;
          transform: translateY(16px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

    }
  </style>

  <section class="hero-section relative pt-6 pb-4 md:pt-10 md:pb-6">
    <!-- Dot-grid background -->
    <div 
      class="hero-grid absolute inset-0 -z-20 h-full w-[100vw] left-1/2 -translate-x-1/2 
             bg-[radial-gradient(circle,#00000018_1px,transparent_1px)] 
             dark:bg-[radial-gradient(circle,#ffffff18_1px,transparent_1px)]"
      aria-hidden="true"
    ></div>

    <!-- Bento grid -->
    <div class="bento-grid">

      <!-- Identity card -->
      <div class="bento-card bento-identity p-5 md:p-6 pb-4 md:pb-5" style="--delay: 0">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/8 border border-primary/10 text-xs font-mono mb-4">
          <span class="relative flex size-2">
            <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-additive/50"></span>
            <span class="relative inline-flex size-2 rounded-full bg-additive"></span>
          </span>
          <span class="text-foreground/70">HPC System Administrator</span>
          <span class="text-muted-foreground/30 mx-0.5">/</span>
          <span class="text-muted-foreground/60">Forvia</span>
        </div>
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-black tracking-tighter uppercase leading-[0.92]">
          Building<br />infrastructure<br /><span class="text-primary">that scales</span>.
        </h1>
        <p class="mt-3 text-sm md:text-[15px] text-muted-foreground/70 max-w-md leading-relaxed">
          System administrator exploring HPC, security &amp; everything in between.
          Writing about what works &mdash; and what spectacularly doesn't.
        </p>
        <div class="flex flex-wrap items-center gap-3 mt-5">
          <Link 
            href="/blog" 
            class={buttonVariants({ variant: 'default', size: 'lg', class: primaryButtonClasses })}
          >
            Read the blog
            <Icon name="lucide:arrow-right" class="ml-2 size-4" aria-hidden="true" />
          </Link>
          <Link 
            href="/about" 
            class={buttonVariants({ variant: 'outline', size: 'lg', class: outlineButtonClasses })}
          >
            About me
          </Link>
        </div>
      </div>

      <!-- Photo card: theme-aware datacenter image (light/dark), one visible by theme -->
      <div class="bento-card bento-photo overflow-hidden relative group h-72 md:h-auto" style="--delay: 80">
        <div class="relative w-full h-full">
          <Image
            src={heroImageLight}
            alt="Robert Melcher in datacenter"
            widths={[300, 500, heroImageLight.width]}
            sizes="(max-width: 768px) 100vw, 280px"
            loading="eager"
            fetchpriority="high"
            class="w-full h-full object-cover object-[center_15%] md:object-top transition-transform duration-700 ease-out group-hover:scale-[1.04] dark:opacity-0 dark:pointer-events-none"
          />
          <Image
            src={heroImageDark}
            alt="Robert Melcher in datacenter"
            widths={[300, 500, heroImageDark.width]}
            sizes="(max-width: 768px) 100vw, 280px"
            loading="eager"
            fetchpriority="high"
            class="absolute inset-0 w-full h-full object-cover object-[center_15%] md:object-top transition-transform duration-700 ease-out group-hover:scale-[1.04] opacity-0 pointer-events-none dark:opacity-100 dark:pointer-events-auto"
          />
        </div>
      </div>

      <!-- Signature card: near photo on mobile, bottom row on desktop -->
      <div class="bento-card bento-signature" style="--delay: 100" aria-label="Signature">
        <span class="signature-text select-none">./merox.sh --live</span>
      </div>

      <!-- Quote card -->
      <div class="bento-card bento-quote p-5 md:p-6 flex items-center" style="--delay: 160">
        <blockquote class="text-lg md:text-xl italic leading-snug text-foreground/90">
          <span class="text-primary/60 not-italic">&ldquo;</span>Works in theory &mdash;<br />now let&rsquo;s see what <span class="text-foreground font-semibold not-italic">doesn&rsquo;t</span><span class="text-primary/60 not-italic">&rdquo;</span>
        </blockquote>
      </div>

      <!-- Connect card -->
      <div class="bento-card bento-connect p-4" style="--delay: 240">
        <div class="flex items-center justify-between mb-3">
          <span class="text-[10px] font-mono uppercase tracking-widest text-foreground/80">Connect</span>
          <div class="flex items-center gap-1.5">
            <span class="relative flex size-1.5">
              <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-additive/50"></span>
              <span class="relative inline-flex size-1.5 rounded-full bg-additive"></span>
            </span>
            <span class="text-[10px] font-mono text-foreground/80">online</span>
          </div>
        </div>
        <nav aria-label="Social links">
          <ul class="flex flex-wrap gap-1.5" role="list">
            {SOCIAL_LINKS.map(({ href, label }: SocialLink) => (
              <li>
                <Link href={href} aria-label={label} title={label} class="social-chip">
                  <Icon 
                    name={ICON_MAP[label as keyof typeof ICON_MAP] || 'lucide:message-circle'} 
                    class="size-3.5 social-chip-icon text-foreground/80 transition-colors" 
                  />
                  <span>{label}</span>
                </Link>
              </li>
            ))}
          </ul>
        </nav>
        <a href="mailto:hello@merox.dev" class="inline-flex items-center gap-1.5 text-xs font-mono text-foreground/85 hover:text-primary transition-colors mt-3">
          <Icon name="lucide:mail" class="size-3" aria-hidden="true" />
          hello@merox.dev
        </a>
      </div>

      <!-- Latest Insight carousel (replaces Linux card) -->
      <div class="bento-card bento-insight p-4 md:p-5" style="--delay: 300">
        <div class="insight-carousel">
          <div class="insight-carousel-header">
            <span class="text-[10px] font-mono uppercase tracking-widest text-foreground/80">Latest Insight</span>
            {latestPostsEnriched.length > 1 ? (
              <nav class="insight-carousel-nav" aria-label="Navigate insights">
                <button type="button" class="insight-carousel-nav-btn insight-prev" aria-label="Previous" disabled={latestPostsEnriched.length <= 1}>
                  <Icon name="lucide:chevron-left" class="size-4" aria-hidden="true" />
                </button>
                <button type="button" class="insight-carousel-nav-btn insight-next" aria-label="Next" disabled={latestPostsEnriched.length <= 1}>
                  <Icon name="lucide:chevron-right" class="size-4" aria-hidden="true" />
                </button>
              </nav>
            ) : null}
          </div>
          {latestPostsEnriched.length > 0 ? (
            <div class="insight-carousel-track" id="insight-track" aria-live="polite" aria-atomic="true">
              {latestPostsEnriched.map(({ entry, readTime, formattedDate }, i) => (
                <div
                  class="insight-slide"
                  data-visible={i === 0 ? 'true' : 'false'}
                  data-index={i}
                  role="group"
                  aria-roledescription="slide"
                  aria-hidden={i !== 0}
                  hidden={i !== 0}
                >
                  <span class="insight-slide-number" aria-hidden="true">{String(i + 1).padStart(2, '0')}</span>
                  <div class="insight-slide-content">
                    <Link href={ensureTrailingSlash(`/blog/${entry.id}`)} class="insight-slide-title-link">
                      <span class="insight-slide-title">{entry.data.title}</span>
                    </Link>
                    {entry.data.description ? (
                      <span class="insight-slide-desc">{entry.data.description}</span>
                    ) : null}
                    <span class="insight-slide-meta">
                      <time datetime={entry.data.date.toISOString()}>{formattedDate}</time>
                      <span aria-hidden="true">·</span>
                      <span>{readTime}</span>
                    </span>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="insight-carousel-track flex items-center justify-center min-h-[5rem]">
              <p class="text-sm text-muted-foreground/80">No posts yet.</p>
            </div>
          )}
          {latestPostsEnriched.length > 0 ? (
            <div class="insight-carousel-footer">
              <Link href="/blog" class="text-xs font-medium text-muted-foreground hover:text-primary transition-colors inline-flex items-center gap-1">
                Explore all posts
                <Icon name="lucide:arrow-right" class="size-3" aria-hidden="true" />
              </Link>
            </div>
          ) : (
            <div class="insight-carousel-footer">
              <Link href="/blog" class="text-xs font-medium text-muted-foreground hover:text-primary transition-colors inline-flex items-center gap-1">
                Go to blog
                <Icon name="lucide:arrow-right" class="size-3" aria-hidden="true" />
              </Link>
            </div>
          )}
        </div>
      </div>

      <!-- Latest played (Last.fm) -->
      <div class="bento-card particle-card lastfm-card bento-bike p-4 md:p-5 flex items-center gap-3 group/lastfm" style="--delay: 360">
        <div class="min-w-0 flex-1 relative z-[1]">
          <span class="text-[10px] font-mono uppercase tracking-widest text-muted-foreground">Latest played</span>
          {lastFmTrack ? (
            <a
              href={lastFmTrack.url}
              target="_blank"
              rel="noopener noreferrer"
              class="block mt-1 group/link"
            >
              <span class="lastfm-track-name group-hover/link:text-primary transition-colors">{lastFmTrack.name}</span>
              <span class="lastfm-artist">{lastFmTrack.artist}</span>
              {lastFmTrack.nowPlaying ? (
                <span class="lastfm-now" aria-label="Now playing">
                  <span class="lastfm-now-dot" aria-hidden="true"></span>
                  Now
                </span>
              ) : null}
            </a>
          ) : (
            <p class="mt-1 text-sm text-muted-foreground">Nothing playing</p>
          )}
        </div>
        {lastFmTrack && (
          <Icon name="lucide:external-link" class="size-3.5 flex-shrink-0 text-muted-foreground/50 group-hover/lastfm:text-primary/70 transition-colors" aria-hidden="true" />
        )}
      </div>
    </div>
  </section>


  {hasError && (
    <section class="mt-8 pt-8">
      <p class="text-muted-foreground text-center">
        Unable to load recent posts. Please try refreshing the page.
      </p>
    </section>
  )}

  {latestPostsEnriched.length > 1 && (
    <script define:vars={{ slideCount: latestPostsEnriched.length }}>
      (function () {
        const track = document.getElementById('insight-track')
        if (!track) return
        const slides = track.querySelectorAll('.insight-slide')
        const prevBtn = document.querySelector('.insight-prev')
        const nextBtn = document.querySelector('.insight-next')
        let current = 0

        function goTo (index) {
          current = (index + slideCount) % slideCount
          slides.forEach((el, i) => {
            const visible = i === current
            el.setAttribute('data-visible', visible ? 'true' : 'false')
            el.setAttribute('aria-hidden', visible ? 'false' : 'true')
            if (visible) el.removeAttribute('hidden')
            else el.setAttribute('hidden', '')
          })
          if (prevBtn) prevBtn.disabled = false
          if (nextBtn) nextBtn.disabled = false
        }

        if (prevBtn) prevBtn.addEventListener('click', () => goTo(current - 1))
        if (nextBtn) nextBtn.addEventListener('click', () => goTo(current + 1))
      })()
    </script>
  )}
</Layout>
