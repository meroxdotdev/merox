---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Link from '@/components/Link.astro'
import Layout from '@/layouts/Layout.astro'
import {
  fetchRecentTracks,
  fetchUserInfo,
  getImageUrl,
  formatLastFmDate,
  type LastFmTrack,
} from '@/lib/lastfm'

// Fetch Last.fm data at build time
let recentTracks: LastFmTrack[] = []
let userInfo: Awaited<ReturnType<typeof fetchUserInfo>> = null
let hasLastFm = false

try {
  const username = import.meta.env.PUBLIC_LASTFM_USERNAME
  const apiKey = import.meta.env.PUBLIC_LASTFM_API_KEY

  if (username && apiKey) {
    hasLastFm = true
    const [tracksResult, userInfoResult] = await Promise.allSettled([
      fetchRecentTracks(username, 10),
      fetchUserInfo(username),
    ])

    recentTracks = tracksResult.status === 'fulfilled' ? tracksResult.value : []
    userInfo = userInfoResult.status === 'fulfilled' && userInfoResult.value ? userInfoResult.value : null
  }
} catch (error) {
  // Silently fail
}
---

<Layout class="max-w-4xl">
  <PageHead slot="head" title="Music" />
  <Breadcrumbs
    items={[
      { label: 'Music', icon: 'lucide:music' },
    ]}
  />

  <div class="flex min-h-[calc(100vh-18rem)] flex-col gap-6 sm:gap-8 pb-6 sm:pb-8">
    <!-- Header -->
    <div class="space-y-1">
      <p class="text-sm sm:text-base text-foreground">
        What I'm <span class="text-primary">Listening To</span>
      </p>
      {!hasLastFm && (
        <p class="text-xs text-muted-foreground">
          Connect your Last.fm account to display music stats.
        </p>
      )}
    </div>

    {hasLastFm && recentTracks.length > 0 ? (
      <div class="space-y-0.5">
        {recentTracks.map((track) => {
          const imageUrl = getImageUrl(track.image, 'medium')
          return (
            <Link
              href={track.url}
              external
              class="group flex items-center gap-2.5 sm:gap-3 rounded-md p-2.5 sm:p-3 -mx-2 sm:-mx-0 hover:bg-muted/40 active:bg-muted/50 transition-colors"
            >
              {imageUrl && (
                <img
                  src={imageUrl}
                  alt=""
                  class="size-12 sm:size-14 rounded shrink-0"
                  loading="lazy"
                  width="56"
                  height="56"
                />
              )}
              <div class="flex-1 min-w-0">
                <p class="text-sm sm:text-base font-medium text-foreground truncate group-hover:text-primary transition-colors">
                  {track.name}
                </p>
                <div class="flex items-center gap-1.5 sm:gap-2 flex-wrap">
                  <p class="text-xs sm:text-sm text-muted-foreground truncate">
                    {track.artist['#text']}
                  </p>
                  {track.date && (
                    <>
                      <span class="text-muted-foreground/30 hidden sm:inline">â€¢</span>
                      <time class="text-xs text-muted-foreground/60">
                        {formatLastFmDate(track.date.uts)}
                      </time>
                    </>
                  )}
                </div>
              </div>
            </Link>
          )
        })}
      </div>
    ) : (
      <div class="rounded-lg border border-border/40 bg-card/30 p-4 sm:p-6 text-center">
        <p class="text-xs sm:text-sm text-muted-foreground">
          Configure <code class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">PUBLIC_LASTFM_USERNAME</code> and <code class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">PUBLIC_LASTFM_API_KEY</code> environment variables.
        </p>
      </div>
    )}
  </div>
</Layout>
