---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Link from '@/components/Link.astro'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import {
  fetchRecentTracks,
  fetchUserInfo,
  getImageUrl,
  formatLastFmDate,
  type LastFmTrack,
} from '@/lib/lastfm'

// Fetch Last.fm data at build time
let recentTracks: LastFmTrack[] = []
let userInfo: Awaited<ReturnType<typeof fetchUserInfo>> = null
let hasLastFm = false

try {
  const username = import.meta.env.PUBLIC_LASTFM_USERNAME
  const apiKey = import.meta.env.PUBLIC_LASTFM_API_KEY

  if (username && apiKey) {
    hasLastFm = true
    const [tracksResult, userInfoResult] = await Promise.allSettled([
      fetchRecentTracks(username, 10),
      fetchUserInfo(username),
    ])

    recentTracks = tracksResult.status === 'fulfilled' ? tracksResult.value : []
    userInfo = userInfoResult.status === 'fulfilled' && userInfoResult.value ? userInfoResult.value : null
  }
} catch (error) {
  // Silently fail
}
---

<Layout class="max-w-4xl">
  <PageHead slot="head" title="Music" />
  <Breadcrumbs
    items={[
      { label: 'Music', href: '/music', icon: 'lucide:music' },
    ]}
  />

  <section class="flex min-h-[calc(100vh-18rem)] flex-col gap-8 pb-12">
    <!-- Header -->
    <div class="space-y-2">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-foreground">
        recently played
      </h1>
      {hasLastFm && (
        <p class="text-xs text-muted-foreground font-mono">
          updated daily at 10:30 UTC
        </p>
      )}
    </div>

    {hasLastFm && recentTracks.length > 0 ? (
      <>
        <!-- Tracks List -->
        <div class="space-y-1">
          {recentTracks.map((track) => {
            const imageUrl = getImageUrl(track.image, 'medium')
            return (
              <Link
                href={track.url}
                external
                class="group flex items-center gap-3 py-2.5 border-b border-border/40 dark:border-border/20 last:border-0 hover:bg-muted/20 transition-colors"
              >
                {imageUrl ? (
                  <img
                    src={imageUrl}
                    alt=""
                    class="size-10 rounded shrink-0"
                    loading="lazy"
                    width="40"
                    height="40"
                  />
                ) : (
                  <div class="size-10 rounded shrink-0 bg-muted/30 flex items-center justify-center border border-border/40 dark:border-border/20">
                    <Icon name="lucide:music" class="h-4 w-4 text-muted-foreground/40" />
                  </div>
                )}
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-foreground truncate group-hover:text-primary transition-colors">
                    {track.name}
                  </p>
                  <div class="flex items-center gap-2 text-xs text-muted-foreground">
                    <span class="truncate">{track.artist['#text']}</span>
                    {track.date && (
                      <>
                        <span>Â·</span>
                        <time class="font-mono">
                          {formatLastFmDate(track.date.uts)}
                        </time>
                      </>
                    )}
                  </div>
                </div>
                <Icon
                  name="lucide:external-link"
                  class="h-3.5 w-3.5 text-muted-foreground/40 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity"
                />
              </Link>
            )
          })}
        </div>

        <!-- View All -->
        {userInfo?.url && (
          <div class="pt-4">
            <Link
              href={userInfo.url}
              external
              class="inline-flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors font-mono"
            >
              view all
              <Icon name="lucide:arrow-up-right" class="h-3 w-3" />
            </Link>
          </div>
        )}
      </>
    ) : hasLastFm ? (
      <div class="rounded-xl border border-border/70 bg-card/80 p-12 text-center">
        <Icon name="lucide:music" class="size-12 text-muted-foreground/50 mx-auto mb-4" />
        <p class="text-muted-foreground mb-2 font-medium">
          No recent tracks found.
        </p>
        <p class="text-sm text-muted-foreground/70">
          Check back later for updates.
        </p>
      </div>
    ) : (
      <div class="rounded-xl border border-border/70 bg-card/80 p-12 text-center">
        <Icon name="lucide:music" class="size-12 text-muted-foreground/50 mx-auto mb-4" />
        <p class="text-muted-foreground mb-2 font-medium">
          Music integration not configured.
        </p>
        <p class="text-sm text-muted-foreground/70 font-mono">
          Configure PUBLIC_LASTFM_USERNAME and PUBLIC_LASTFM_API_KEY
        </p>
      </div>
    )}
  </section>
</Layout>
