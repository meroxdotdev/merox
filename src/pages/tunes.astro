---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Link from '@/components/Link.astro'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import {
  fetchRecentTracks,
  fetchUserInfo,
  formatLastFmDate,
  type LastFmTrack,
} from '@/lib/lastfm'

// Fetch Last.fm data at build time
let recentTracks: LastFmTrack[] = []
let userInfo: Awaited<ReturnType<typeof fetchUserInfo>> = null
let hasLastFm = false

try {
  const username = import.meta.env.PUBLIC_LASTFM_USERNAME
  const apiKey = import.meta.env.PUBLIC_LASTFM_API_KEY

  if (username && apiKey) {
    hasLastFm = true
    const [tracksResult, userInfoResult] = await Promise.allSettled([
      fetchRecentTracks(username, 10),
      fetchUserInfo(username),
    ])

    recentTracks = tracksResult.status === 'fulfilled' ? tracksResult.value : []
    userInfo = userInfoResult.status === 'fulfilled' && userInfoResult.value ? userInfoResult.value : null

    // Log in dev mode only if tracks failed to fetch (not if empty - that's normal)
    if (import.meta.env.DEV && tracksResult.status === 'rejected') {
      console.warn('Failed to fetch Last.fm tracks:', tracksResult.reason)
    }
  }
} catch (error) {
  // Silently fail in production, but log in dev
  if (import.meta.env.DEV && error instanceof Error) {
    console.warn('Error fetching Last.fm data:', error.message)
  }
}
---

<Layout class="max-w-4xl">
  <PageHead slot="head" title="Tunes" />
  <Breadcrumbs
    items={[
      { label: 'Tunes', href: '/tunes', icon: 'lucide:music' },
    ]}
  />

  <section class="flex min-h-[calc(100vh-18rem)] flex-col gap-6 pb-12">
    <!-- Header -->
    <div class="space-y-1">
      <h1 class="text-xl md:text-2xl font-bold tracking-tight text-foreground font-mono uppercase">
        ▶ recently played
      </h1>
      {hasLastFm && (
        <p class="text-[10px] text-muted-foreground font-mono">
          [updated daily at 09:00 UTC]
        </p>
      )}
    </div>

    {hasLastFm && recentTracks.length > 0 ? (
      <>
        <!-- Retro Player Container -->
        <div class="border border-border/60 dark:border-border/40 bg-muted/20 dark:bg-muted/10 rounded-sm p-3 font-mono">
          <!-- Player Header -->
          <div class="flex items-center justify-between mb-3 pb-2 border-b border-border/40 dark:border-border/20">
            <div class="flex items-center gap-2 text-[10px] text-muted-foreground uppercase tracking-wider">
              <span class="inline-block w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
              <span>track list</span>
            </div>
            <div class="text-[10px] text-muted-foreground/60 font-mono">
              {recentTracks.length} tracks
            </div>
          </div>

          <!-- Tracks List - Retro Style -->
          <div class="space-y-0.5">
            {recentTracks.map((track, index) => {
              const isPlaying = track['@attr']?.nowplaying === 'true'
              return (
                <Link
                  href={track.url}
                  external
                  class="group block px-2 py-1.5 border border-transparent hover:border-border/40 dark:hover:border-border/20 hover:bg-muted/30 dark:hover:bg-muted/20 transition-all"
                >
                  <div class="flex items-center gap-3">
                    <!-- Track Number -->
                    <div class="w-6 shrink-0 text-[10px] text-muted-foreground/60 font-mono tabular-nums">
                      {String(index + 1).padStart(2, '0')}.
                    </div>
                    
                    <!-- Track Info -->
                    <div class="flex-1 min-w-0">
                      <div class="flex items-baseline gap-2 mb-0.5">
                        <p class="text-xs font-medium text-foreground truncate group-hover:text-primary transition-colors">
                          {track.name}
                        </p>
                        {isPlaying && (
                          <span class="text-[9px] text-primary font-mono uppercase tracking-wider shrink-0">
                            ▶
                          </span>
                        )}
                      </div>
                      <div class="flex items-center gap-2 text-[10px] text-muted-foreground">
                        <span class="truncate font-mono">{track.artist['#text']}</span>
                        {track.date && (
                          <>
                            <span class="text-muted-foreground/40">|</span>
                            <time class="font-mono tabular-nums text-muted-foreground/70">
                              {formatLastFmDate(track.date.uts)}
                            </time>
                          </>
                        )}
                      </div>
                    </div>
                    
                    <!-- External Link Indicator -->
                    <div class="shrink-0 w-4 text-center">
                      <Icon
                        name="lucide:external-link"
                        class="h-2.5 w-2.5 text-muted-foreground/30 group-hover:text-muted-foreground/60 transition-colors"
                      />
                    </div>
                  </div>
                </Link>
              )
            })}
          </div>
        </div>

        <!-- View All - Retro Style -->
        {(userInfo?.url || (hasLastFm && import.meta.env.PUBLIC_LASTFM_USERNAME)) && (
          <div class="pt-2">
            <Link
              href={userInfo?.url || `https://www.last.fm/user/${import.meta.env.PUBLIC_LASTFM_USERNAME}`}
              external
              class="inline-flex items-center gap-1.5 text-[10px] text-muted-foreground hover:text-foreground transition-colors font-mono uppercase tracking-wider"
            >
              <span>→</span>
              <span>view all on last.fm</span>
            </Link>
          </div>
        )}
      </>
    ) : hasLastFm ? (
      <div class="border border-border/60 dark:border-border/40 bg-muted/20 dark:bg-muted/10 rounded-sm p-8 text-center font-mono">
        <Icon name="lucide:music" class="size-8 text-muted-foreground/50 mx-auto mb-3" />
        <p class="text-sm text-muted-foreground mb-1 font-medium">
          No recent tracks found.
        </p>
        <p class="text-[10px] text-muted-foreground/70 uppercase tracking-wider">
          [check back later]
        </p>
      </div>
    ) : (
      <div class="border border-border/60 dark:border-border/40 bg-muted/20 dark:bg-muted/10 rounded-sm p-8 text-center font-mono">
        <Icon name="lucide:music" class="size-8 text-muted-foreground/50 mx-auto mb-3" />
        <p class="text-sm text-muted-foreground mb-1 font-medium">
          Music integration not configured.
        </p>
        <p class="text-[10px] text-muted-foreground/70 uppercase tracking-wider">
          [configure PUBLIC_LASTFM_USERNAME and PUBLIC_LASTFM_API_KEY]
        </p>
      </div>
    )}
  </section>
</Layout>
