---
import { SOCIAL_LINKS, SITE } from '@/consts'
import Link from '@/components/Link.astro'
import { Icon } from 'astro-icon/components'
import { ICON_MAP } from '@/consts'
import { fetchGitHubCommits, type GitHubCommit } from '@/lib/github'

const currentYear = new Date().getFullYear()
const footerSocials = SOCIAL_LINKS.filter(link => link.label !== 'RSS')

// Fetch latest commit from merox repo only
// Using retry logic to handle rate limiting during build
let latestCommit: GitHubCommit | null = null
try {
  const commits = await fetchGitHubCommits('meroxdotdev', 'merox', 1, 2)
  if (commits.length > 0) {
    latestCommit = commits[0]
  } else if (import.meta.env.DEV) {
    console.warn('No commits found for meroxdotdev/merox - this might be due to rate limiting or API issues')
  }
} catch (error) {
  // Silently fail in production, but log in dev
  if (import.meta.env.DEV && error instanceof Error) {
    console.warn('Error fetching GitHub commits:', error.message)
  }
}

// Format relative time
function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString)
  const now = new Date()
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000)
  
  if (diffInSeconds < 60) return 'just now'
  if (diffInSeconds < 3600) {
    const minutes = Math.floor(diffInSeconds / 60)
    return `${minutes}m ago`
  }
  if (diffInSeconds < 86400) {
    const hours = Math.floor(diffInSeconds / 3600)
    return `${hours}h ago`
  }
  const days = Math.floor(diffInSeconds / 86400)
  if (days < 7) {
    return `${days}d ago`
  }
  const weeks = Math.floor(days / 7)
  return `${weeks}w ago`
}
---

<footer class="border-t border-border/60 dark:border-border/40" role="contentinfo">
  <div class="mx-auto max-w-4xl px-4 py-6 sm:py-5">
    <div class="flex flex-col gap-5 sm:gap-4">
      
      <!-- Row 1: Copyright + Navigation | Social Icons -->
      <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-between sm:items-center">
        <div class="flex flex-col items-center gap-4 sm:flex-row sm:items-center sm:gap-4">
          <span class="text-xs text-muted-foreground">&copy; {currentYear} Robert Melcher</span>
          
          <span class="hidden sm:inline text-border/50 text-xs">|</span>
          
          <nav class="flex flex-wrap items-center justify-center gap-x-3 gap-y-2 text-xs text-muted-foreground sm:gap-3" aria-label="Footer navigation">
            <Link href="/blog/" class="hover:text-foreground transition-colors">Blog</Link>
            <span class="text-border/50">·</span>
            <Link href="/projects/" class="hover:text-foreground transition-colors">Projects</Link>
            <span class="text-border/50">·</span>
            <Link href="/tunes/" class="hover:text-foreground transition-colors">Tunes</Link>
            <span class="text-border/50">·</span>
            <Link href="/tags/" class="hover:text-foreground transition-colors">Tags</Link>
            <span class="text-border/50">·</span>
            <Link href="/about/" class="hover:text-foreground transition-colors">About</Link>
          </nav>
        </div>
        
        <!-- Social Icons - Desktop Only -->
        <div class="hidden sm:flex items-center gap-1">
          {footerSocials.map(({ href, label }) => (
            <Link
              href={href}
              aria-label={label}
              title={label}
              class="p-1.5 text-muted-foreground hover:text-foreground transition-colors"
              external
            >
              <Icon
                name={ICON_MAP[label as keyof typeof ICON_MAP] || 'lucide:link'}
                class="size-3.5"
              />
            </Link>
          ))}
          <Link
            href="/rss.xml"
            aria-label="RSS Feed"
            title="RSS Feed"
            class="p-1.5 text-muted-foreground hover:text-foreground transition-colors"
          >
            <Icon name="lucide:rss" class="size-3.5" />
          </Link>
        </div>
      </div>
      
      <!-- Row 2: Privacy + Terms | Commit -->
      <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-between sm:items-center">
        <div class="flex items-center gap-3 text-xs text-muted-foreground">
          <Link href="/privacy/" class="hover:text-foreground transition-colors">Privacy</Link>
          <span class="text-border/50">·</span>
          <Link href="/terms/" class="hover:text-foreground transition-colors">Terms</Link>
        </div>
        
        <!-- Commit - Desktop Only -->
        {latestCommit && (
          <div class="hidden sm:flex">
            <a
              href={latestCommit.html_url}
              target="_blank"
              rel="noopener noreferrer"
              class="group inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-muted/40 hover:bg-muted/60 border border-border/40 hover:border-border/60 transition-all duration-200 text-xs text-muted-foreground hover:text-foreground"
              title={`Latest commit: ${latestCommit.commit.message.split('\n')[0]}`}
            >
              <Icon name="lucide:git-commit" class="size-3 shrink-0" aria-hidden="true" />
              <span class="font-mono">{latestCommit.sha.slice(0, 7)}</span>
              <span class="text-muted-foreground/70 group-hover:text-muted-foreground">
                {formatRelativeTime(latestCommit.commit.author.date)}
              </span>
            </a>
          </div>
        )}
        
        <!-- Social Icons - Mobile Only -->
        <div class="flex sm:hidden items-center gap-1">
          {footerSocials.map(({ href, label }) => (
            <Link
              href={href}
              aria-label={label}
              title={label}
              class="p-2 text-muted-foreground hover:text-foreground transition-colors"
              external
            >
              <Icon
                name={ICON_MAP[label as keyof typeof ICON_MAP] || 'lucide:link'}
                class="size-4"
              />
            </Link>
          ))}
          <Link
            href="/rss.xml"
            aria-label="RSS Feed"
            title="RSS Feed"
            class="p-2 text-muted-foreground hover:text-foreground transition-colors"
          >
            <Icon name="lucide:rss" class="size-4" />
          </Link>
        </div>
      </div>
    </div>
  </div>
</footer>
