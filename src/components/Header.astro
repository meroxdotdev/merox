---
import Link from '@/components/Link.astro'
import ThemeToggle from '@/components/ThemeToggle.astro'
import MobileMenu from '@/components/ui/mobile-menu'
import { NAV_LINKS } from '@/consts'
import { Image } from 'astro:assets'
import logo from '../../public/static/logo.svg'
import logod from '../../public/static/logod.svg'
---

<header
  class="sticky top-0 z-50 w-full transition-all duration-300"
  transition:persist
  id="main-header"
>
  <div
    id="header-wrapper"
    class="mx-auto w-full max-w-3xl transition-all duration-300 ease-out px-4 pt-4"
  >
    <div
      id="header-inner"
      class="relative overflow-hidden flex items-center justify-between border-b border-border/50 bg-background/80 backdrop-blur-sm px-4 py-3 xl:rounded-xl xl:border xl:border-primary/20 xl:bg-gradient-to-br xl:from-primary/5 xl:via-primary/3 xl:to-transparent xl:px-8 xl:py-4 xl:backdrop-blur-sm xl:transition-all xl:duration-300 xl:ease-out"
    >
      <!-- Subtle gradient orbs (matching footer style) -->
      <div class="absolute -top-10 -left-10 hidden w-24 h-24 bg-primary/10 rounded-full blur-2xl xl:block" aria-hidden="true"></div>
      <div class="absolute -bottom-10 -right-10 hidden w-24 h-24 bg-primary/5 rounded-full blur-2xl xl:block" aria-hidden="true"></div>

      <!-- Logo -->
      <Link
        href="/"
        class="relative z-10 group flex items-center gap-2.5 transition-opacity duration-200 hover:opacity-80"
        aria-label="Home"
      >
        <div class="relative flex-shrink-0 transition-transform duration-300 group-hover:scale-105">
          <Image
            src={logo}
            alt="Logo"
            class="hidden size-7 transition-opacity duration-300 dark:block xl:size-8"
            width={32}
            height={32}
          />
          <Image
            src={logod}
            alt="Logo"
            class="block size-7 transition-opacity duration-300 dark:hidden xl:size-8"
            width={32}
            height={32}
          />
        </div>
      </Link>

      <!-- Navigation & Actions -->
      <div class="relative z-10 flex items-center gap-1.5 xl:gap-2">
        <!-- Desktop Navigation (only on extra large screens) -->
        <nav class="hidden xl:flex items-center gap-1" aria-label="Main navigation">
          {NAV_LINKS.map((item) => (
            <Link
              href={item.href}
              class="nav-link relative px-4 py-2 text-sm font-medium text-foreground/70 transition-all duration-200 rounded-lg hover:text-foreground"
            >
              <span class="relative z-10">{item.label}</span>
              <span class="nav-link-underline absolute bottom-1.5 left-4 right-4 h-[1.5px] bg-foreground/20 scale-x-0 origin-center transition-transform duration-200 rounded-full" aria-hidden="true"></span>
            </Link>
          ))}
        </nav>

        <!-- Mobile Menu + Theme Toggle -->
        <div class="flex items-center gap-1.5">
          <MobileMenu client:load transition:persist />
          <ThemeToggle transition:persist />
        </div>
      </div>
    </div>
  </div>

  <!-- Header Scroll Controller -->
  <script define:vars={{ breakpoint: 1280 }}>
    {
      if (typeof window !== 'undefined') {
        /**
         * Header scroll controller with shrink effect
         * Follows Astro best practices and modern JavaScript patterns
         */
        (() => {
          'use strict'

          // Constants
          const SCROLL_THRESHOLD = 32
          const DESKTOP_BREAKPOINT = breakpoint
          const HEADER_IDS = {
            wrapper: 'header-wrapper',
            inner: 'header-inner',
          }

          // State management
          let state = {
            ticking: false,
            lastScrollY: 0,
            elements: {
              wrapper: null,
              inner: null,
            },
          }

          /**
           * Get header elements from DOM
           * @returns {Object|null} Elements object or null if not found
           */
          const getElements = () => {
            const wrapper = document.getElementById(HEADER_IDS.wrapper)
            const inner = document.getElementById(HEADER_IDS.inner)
            
            if (!wrapper || !inner) {
              return null
            }

            return { wrapper, inner }
          }

          /**
           * Check if current viewport is desktop size
           * @returns {boolean}
           */
          const isDesktop = () => {
            return window.innerWidth >= DESKTOP_BREAKPOINT
          }

          /**
           * Update header shrink state based on scroll position
           */
          const updateHeaderState = () => {
            const elements = getElements()
            if (!elements) {
              state.ticking = false
              return
            }

            const { wrapper, inner } = elements
            const currentScroll = window.scrollY
            const isScrolled = currentScroll > SCROLL_THRESHOLD
            const wasScrolled = state.lastScrollY > SCROLL_THRESHOLD

            // Reset shrink state on mobile/tablet
            if (!isDesktop()) {
              wrapper.classList.remove('shrink')
              inner.classList.remove('shrink')
              state.ticking = false
              state.lastScrollY = currentScroll
              return
            }

            // Apply shrink effect on desktop
            if (isScrolled && !wasScrolled) {
              wrapper.classList.add('shrink')
              inner.classList.add('shrink')
            } else if (!isScrolled && wasScrolled) {
              wrapper.classList.remove('shrink')
              inner.classList.remove('shrink')
            }

            state.lastScrollY = currentScroll
            state.ticking = false
          }

          /**
           * Throttled scroll handler using requestAnimationFrame
           */
          const handleScroll = () => {
            if (!state.ticking) {
              window.requestAnimationFrame(updateHeaderState)
              state.ticking = true
            }
          }

          /**
           * Initialize header controller
           */
          const init = () => {
            // Reset state
            state.ticking = false
            state.lastScrollY = window.scrollY
            state.elements = getElements()

            // Initial state update
            updateHeaderState()

            // Attach scroll listener
            window.addEventListener('scroll', handleScroll, { passive: true })
          }

          /**
           * Cleanup header controller
           */
          const cleanup = () => {
            // Remove event listeners
            window.removeEventListener('scroll', handleScroll)

            // Reset shrink state
            const elements = getElements()
            if (elements) {
              elements.wrapper.classList.remove('shrink')
              elements.inner.classList.remove('shrink')
            }

            // Reset state
            state.ticking = false
            state.lastScrollY = 0
            state.elements = { wrapper: null, inner: null }
          }

          // Astro navigation event handlers
          document.addEventListener('astro:page-load', init)
          document.addEventListener('astro:after-swap', () => {
            cleanup()
            // Use requestAnimationFrame instead of setTimeout for better performance
            requestAnimationFrame(() => {
              requestAnimationFrame(init)
            })
          })
          document.addEventListener('astro:before-swap', cleanup)

          // Initial load
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init)
          } else {
            init()
          }
        })()
      }
    }
  </script>

  <style>
    /* Mobile & Tablet: Clean minimal style */
    @media (max-width: 1279px) {
      #header-inner {
        border-radius: 0;
        box-shadow: none;
        background: hsl(var(--background) / 0.85);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid hsl(var(--border) / 0.5);
        border-top: none;
        border-left: none;
        border-right: none;
        padding: 0.875rem 1rem;
      }

      .dark #header-inner {
        background: hsl(var(--background) / 0.85);
      }
    }

    /* Desktop: Modern design matching site */
    @media (min-width: 1280px) {
      .nav-link:hover .nav-link-underline {
        transform: scaleX(1);
      }

      .nav-link:focus-visible {
        outline: 2px solid hsl(var(--primary));
        outline-offset: 2px;
        border-radius: 0.5rem;
      }

      /* Scroll shrink effect */
      #header-wrapper.shrink {
        max-width: 36rem;
        transform: translateY(-1px) scale(0.99);
      }

      #header-wrapper.shrink #header-inner {
        padding-left: 1.25rem;
        padding-right: 1.25rem;
        padding-top: 0.875rem;
        padding-bottom: 0.875rem;
        border-radius: 0.75rem;
      }

      #header-wrapper.shrink img {
        transform: scale(0.95);
      }

      #header-wrapper.shrink nav > * {
        padding-left: 0.875rem;
        padding-right: 0.875rem;
        font-size: 0.8125rem;
      }
    }
  </style>
</header>