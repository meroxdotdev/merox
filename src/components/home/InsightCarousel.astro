---
import Link from '@/components/Link.astro'
import { Icon } from 'astro-icon/components'
import { ensureTrailingSlash } from '@/lib/utils'

interface Post {
  id: string
  data: {
    title: string
    description?: string
    date: Date
  }
}

interface Props {
  posts: Array<{
    entry: Post
    readTime: string
    formattedDate: string
  }>
}

const { posts } = Astro.props
const slideCount = posts.length
---

<div class="bento-card bento-insight">
  <div class="insight-carousel">
    <div class="insight-carousel-header">
      <span class="panel-title uppercase">Latest Insights</span>
      {slideCount > 1 ? (
        <nav class="insight-carousel-nav" aria-label="Navigate insights">
          <button 
            type="button" 
            id="insight-prev" 
            class="insight-carousel-nav-btn" 
            aria-label="Previous insight" 
            disabled
            aria-keyshortcuts="ArrowLeft"
          >
            <Icon name="lucide:chevron-left" class="size-4" aria-hidden="true" />
          </button>
          <button 
            type="button" 
            id="insight-next" 
            class="insight-carousel-nav-btn" 
            aria-label="Next insight" 
            aria-keyshortcuts="ArrowRight"
          >
            <Icon name="lucide:chevron-right" class="size-4" aria-hidden="true" />
          </button>
        </nav>
      ) : null}
    </div>
    {slideCount > 0 ? (
      <div 
        class="insight-carousel-track" 
        id="insight-track" 
        data-slide-count={slideCount}
        data-current-index="0"
        aria-live="polite" 
        aria-atomic="true"
        tabindex="0"
        role="region"
        aria-label="Latest insights carousel"
      >
        {posts.map(({ entry, readTime, formattedDate }, i) => (
          <div
            class="insight-slide"
            data-visible={i === 0 ? 'true' : 'false'}
            data-index={i}
            role="group"
            aria-roledescription="slide"
            aria-label={`Insight ${i + 1} of ${slideCount}`}
            aria-hidden={i !== 0}
            hidden={i !== 0}
          >
            <span class="insight-slide-number" aria-hidden="true">{String(i + 1).padStart(2, '0')}</span>
            <div class="insight-slide-content">
              <Link href={ensureTrailingSlash(`/blog/${entry.id}`)} class="insight-slide-title-link">
                <span class="insight-slide-title">{entry.data.title}</span>
              </Link>
              {entry.data.description ? (
                <span class="insight-slide-desc">{entry.data.description}</span>
              ) : null}
              <span class="insight-slide-meta">
                <time datetime={entry.data.date.toISOString()}>{formattedDate}</time>
                <span aria-hidden="true">Â·</span>
                <span>{readTime}</span>
              </span>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="insight-carousel-track flex items-center justify-center min-h-[5rem]">
        <p class="text-sm text-muted-foreground/80">No posts yet.</p>
      </div>
    )}
    <div class="insight-carousel-footer">
      <Link href="/blog" class="text-xs font-medium text-muted-foreground hover:text-primary transition-colors inline-flex items-center gap-1">
        {slideCount > 0 ? 'Explore all posts' : 'Go to blog'}
        <Icon name="lucide:arrow-right" class="size-3" aria-hidden="true" />
      </Link>
    </div>
  </div>
</div>

{slideCount > 1 && (
  <script is:inline>
    (function() {
      'use strict'
      
      const trackId = 'insight-track'
      const prevBtnId = 'insight-prev'
      const nextBtnId = 'insight-next'
      const slideSelector = '.insight-slide'
      const SWIPE_THRESHOLD = 50

      const applySlideState = (track, slides, prevBtn, nextBtn, currentIndex, slideCount) => {
        slides.forEach((el, i) => {
          const visible = i === currentIndex
          el.setAttribute('data-visible', visible ? 'true' : 'false')
          el.setAttribute('aria-hidden', String(!visible))
          el.toggleAttribute('hidden', !visible)
        })
        track.dataset.currentIndex = String(currentIndex)
        if (prevBtn) prevBtn.disabled = currentIndex === 0
        if (nextBtn) nextBtn.disabled = currentIndex === slideCount - 1
        const currentSlide = slides[currentIndex]
        if (currentSlide) {
          const title = currentSlide.querySelector('.insight-slide-title')?.textContent || ''
          track.setAttribute('aria-label', `Showing insight ${currentIndex + 1} of ${slideCount}: ${title}`)
        }
      }

      const setupCarousel = () => {
        const track = document.getElementById(trackId)
        const prevBtn = document.getElementById(prevBtnId)
        const nextBtn = document.getElementById(nextBtnId)
        
        if (!track || !prevBtn || !nextBtn) return

        const slides = track.querySelectorAll(slideSelector)
        const count = parseInt(track.dataset.slideCount || '0', 10)
        if (slides.length === 0 || count <= 1) return

        const current = parseInt(track.dataset.currentIndex || '0', 10)
        applySlideState(track, slides, prevBtn, nextBtn, current, count)

        prevBtn.addEventListener('click', () => {
          const cur = parseInt(track.dataset.currentIndex || '0', 10)
          if (cur > 0) {
            applySlideState(track, slides, prevBtn, nextBtn, cur - 1, count)
          }
        })

        nextBtn.addEventListener('click', () => {
          const cur = parseInt(track.dataset.currentIndex || '0', 10)
          if (cur < count - 1) {
            applySlideState(track, slides, prevBtn, nextBtn, cur + 1, count)
          }
        })

        track.addEventListener('keydown', (e) => {
          const cur = parseInt(track.dataset.currentIndex || '0', 10)
          if (e.key === 'ArrowLeft' && cur > 0) {
            e.preventDefault()
            applySlideState(track, slides, prevBtn, nextBtn, cur - 1, count)
            prevBtn.focus()
          } else if (e.key === 'ArrowRight' && cur < count - 1) {
            e.preventDefault()
            applySlideState(track, slides, prevBtn, nextBtn, cur + 1, count)
            nextBtn.focus()
          } else if (e.key === 'Home') {
            e.preventDefault()
            applySlideState(track, slides, prevBtn, nextBtn, 0, count)
          } else if (e.key === 'End') {
            e.preventDefault()
            applySlideState(track, slides, prevBtn, nextBtn, count - 1, count)
          }
        })

        let touchStartX = 0
        track.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX
        }, { passive: true })
        
        track.addEventListener('touchend', (e) => {
          const touchEndX = e.changedTouches[0].screenX
          const diff = touchStartX - touchEndX
          if (Math.abs(diff) > SWIPE_THRESHOLD) {
            const cur = parseInt(track.dataset.currentIndex || '0', 10)
            if (diff > 0 && cur < count - 1) {
              applySlideState(track, slides, prevBtn, nextBtn, cur + 1, count)
            } else if (diff < 0 && cur > 0) {
              applySlideState(track, slides, prevBtn, nextBtn, cur - 1, count)
            }
          }
        }, { passive: true })
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupCarousel)
      } else {
        setupCarousel()
      }
    })()
  </script>
)}
