---
import { Icon } from 'astro-icon/components'
import { GITHUB_REPOS } from '@/consts'

// Single source of truth: config. No API dependency for the tree; list always renders.
const projects = GITHUB_REPOS.map(({ owner, repo }) => ({
  name: repo,
  html_url: `https://github.com/${owner}/${repo}`,
}))

const directoriesCount = 2 // src, projects (fixed structure)
const filesCount = projects.length
const directoriesLabel = 'directories' // fixed structure always has 2
const filesLabel = filesCount === 1 ? 'file' : 'links'
---

<div class="bento-card bento-stats file-tree-card" role="region" aria-label="Projects">
  <div class="file-tree-card__header">
    <span class="panel-title uppercase">Projects</span>
  </div>
  <div class="file-tree-card__tree-wrapper">
    <span class="tree-command" aria-hidden="true"><span class="tree-command__prompt">merox@webserver:</span><span class="tree-command__tilde">~</span><span class="tree-command__suffix">$</span><span class="tree-command__cmd">tree</span><span class="tree-command__path">src/projects</span><span class="tree-cursor" aria-hidden="true"></span></span>
    <nav class="tree-container" aria-label="Project repositories">
      <ul class="tree-list">
        <li class="tree-item">
          <details class="tree-details" open>
            <summary class="tree-summary">
              <Icon name="lucide:folder" class="tree-icon tree-icon--closed" aria-hidden="true" />
              <Icon name="lucide:folder-open" class="tree-icon tree-icon--open" aria-hidden="true" />
              <span>src</span>
            </summary>
            <ul class="tree-children">
              <li class="tree-item">
                <details class="tree-details" open>
                  <summary class="tree-summary">
                    <Icon name="lucide:folder" class="tree-icon tree-icon--closed" aria-hidden="true" />
                    <Icon name="lucide:folder-open" class="tree-icon tree-icon--open" aria-hidden="true" />
                    <span>projects</span>
                  </summary>
                  <ul class="tree-children">
                    {projects.map((project) => (
                      <li class="tree-item">
                        <a
                          href={project.html_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="tree-file tree-file--link"
                        >
                          <Icon name="lucide:folder-git" class="tree-icon tree-icon--file" aria-hidden="true" />
                          <span class="tree-file-name">{project.name}</span>
                        </a>
                      </li>
                    ))}
                  </ul>
                </details>
              </li>
            </ul>
          </details>
        </li>
      </ul>
    </nav>
    <p class="tree-footer"> {directoriesCount} {directoriesLabel}, {filesCount} {filesLabel}</p>
  </div>
</div>

<style>
  .file-tree-card {
    padding: var(--bento-inner-lg);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-height: 0;
    --file-tree-line: color-mix(in srgb, var(--border) 80%, transparent);
    --file-tree-hover: color-mix(in srgb, var(--muted) 40%, transparent);
    --tree-font-mono: ui-monospace, "Cascadia Code", "Source Code Pro", "Fira Code", "SF Mono", Menlo, Consolas, monospace;
    --tree-prompt-green: hsl(142 36% 36%);
  }

  :global(html[data-theme="dark"]) .file-tree-card {
    --file-tree-line: color-mix(in srgb, var(--border) 70%, transparent);
    --file-tree-hover: color-mix(in srgb, var(--muted) 35%, transparent);
    --tree-prompt-green: hsl(142 38% 55%);
  }

  .file-tree-card__header {
    flex-shrink: 0;
  }

  .file-tree-card__tree-wrapper {
    min-height: 0;
    overflow: visible;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .tree-command {
    font-family: var(--tree-font-mono);
    font-size: 0.75rem;
    color: var(--muted-foreground);
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    gap: 0;
  }

  .tree-cursor {
    display: inline-block;
    width: 0.45em;
    height: 1em;
    margin-left: 2px;
    background: var(--tree-prompt-green);
    border-radius: 1px;
    vertical-align: text-bottom;
    flex-shrink: 0;
  }

  @media (prefers-reduced-motion: no-preference) {
    .tree-cursor {
      animation: tree-cursor-blink 1.1s step-end infinite;
    }
    .tree-container {
      animation: tree-output-in 0.45s var(--ease-apple) 0.2s both;
    }
  }

  @keyframes tree-cursor-blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  @keyframes tree-output-in {
    from {
      opacity: 0;
      transform: translateY(3px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .tree-command__prompt {
    color: var(--tree-prompt-green);
  }

  /* ~ = blue from site colorscheme */
  .tree-command__tilde {
    color: var(--primary);
  }

  /* $ and space = normal */
  .tree-command__suffix {
    color: var(--muted-foreground);
  }

  .tree-command__cmd {
    margin-left: 0.25em; /* space after $ */
  }

  .tree-command__path {
    color: color-mix(in srgb, var(--primary) 45%, var(--muted-foreground));
    margin-left: 0.25em; /* space before path (flex eats text-node space) */
  }

  .tree-footer {
    margin: 0;
    margin-top: 0.5rem;
    font-family: var(--tree-font-mono);
    font-size: 0.75rem;
    color: var(--muted-foreground);
    flex-shrink: 0;
  }

  .tree-container {
    padding: 0;
  }

  .tree-list,
  .tree-children {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tree-children {
    margin-left: 0.5rem;
    padding-left: 0.5rem;
    border-left: 1px solid var(--file-tree-line);
  }

  .tree-item {
    position: relative;
    margin-top: 0;
  }

  .tree-children .tree-item::before {
    content: "";
    position: absolute;
    left: -0.5rem;
    top: 10px;
    width: 0.5rem;
    height: 1px;
    background-color: var(--file-tree-line);
  }

  .tree-details {
    margin: 0;
  }

  .tree-summary {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 1px 4px;
    border-radius: 4px;
    font-size: 0.8125rem;
    color: var(--foreground);
    cursor: pointer;
    user-select: none;
    min-height: 20px;
    list-style: none;
    transition: background-color 0.15s ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .tree-summary,
    .tree-file {
      transition: none;
    }
  }

  .tree-summary::-webkit-details-marker,
  .tree-summary::marker {
    display: none;
  }

  .tree-summary:hover {
    background-color: var(--file-tree-hover);
  }

  .tree-summary:focus-visible {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .tree-details[open] .tree-summary .tree-icon--closed {
    display: none;
  }

  .tree-details[open] .tree-summary .tree-icon--open {
    display: block;
    color: var(--primary);
  }

  .tree-details:not([open]) .tree-summary .tree-icon--open {
    display: none;
  }

  .tree-details:not([open]) .tree-summary .tree-icon--closed {
    display: block;
  }

  .tree-file {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 1px 4px;
    border-radius: 4px;
    font-size: 0.8125rem;
    color: var(--foreground);
    text-decoration: none;
    min-height: 20px;
    transition: background-color 0.15s ease;
  }

  .tree-file--link:hover {
    background-color: var(--file-tree-hover);
    color: var(--primary);
  }

  .tree-file--link:focus-visible {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .tree-file-name {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .tree-icon {
    width: 0.875rem;
    height: 0.875rem;
    flex-shrink: 0;
    color: var(--muted-foreground);
  }

  .tree-icon--file {
    color: var(--muted-foreground);
  }
</style>
