name: Update Tunes Page

on:
  schedule:
    # Run daily at 13:30 UTC (15:30 Romania time - EET / 16:30 EEST)
    - cron: '00 14 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Cloudflare Pages rebuild via API
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ] || [ -z "$CLOUDFLARE_PROJECT_NAME" ]; then
            echo "Error: Cloudflare API credentials are missing!"
            echo "Please set CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID, and CLOUDFLARE_PROJECT_NAME as GitHub secrets."
            exit 1
          fi
          
          echo "Triggering Cloudflare Pages rebuild via API..."
          # Try without branch first (uses production branch)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Successfully triggered Cloudflare Pages rebuild!"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          else
            echo "‚ö†Ô∏è  First attempt failed, trying with explicit branch..."
            # Try with explicit branch
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{"branch":"main"}')
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
              echo "‚úÖ Successfully triggered Cloudflare Pages rebuild!"
              echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            else
              echo "‚ùå Failed to trigger rebuild. HTTP Status: $HTTP_CODE"
              echo "$BODY"
              echo ""
              echo "üí° Tip: Check that:"
              echo "   1. CLOUDFLARE_PROJECT_NAME matches your Pages project name exactly"
              echo "   2. Your API token has 'Pages Write' permission"
              echo "   3. The production branch is set correctly in Cloudflare Pages settings"
              exit 1
            fi
          fi
